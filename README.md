# 智能笔记管理器（note-ai-manager）

一个基于 FastAPI + 原生前端的本地可用「智能笔记」应用：

- AI 自动分析笔记内容并提取「分类、标签」（仅分析前500字符）
- 一键 AI 优化正文并生成标题（默认不修改内容，仅提取标题、分类、标签）
- 笔记保存到 SQLite 与本地 Markdown 文件，支持全文搜索
- 词云展示热门分类与标签，点击可筛选
- 前后端本地运行，默认无需外网（可接入兼容 OpenAI 的本地/远程模型）


## 功能特性

- 自动分类与标签：调用兼容 OpenAI 的 API，根据正文前500字符智能归类并打标签
- 文本优化与标题生成：默认仅提取标题、分类、标签，不修改原文；支持自定义提示词进行内容优化
- 全文检索与条件过滤：支持搜索、按分类/标签过滤
- 全屏编辑模式：支持全屏显示笔记，提供更大的编辑空间和更好的阅读体验
- 本地持久化：SQLite 数据库 + `notes/分类/标题.md` 文件
- 纯前端页面：无需构建，打开即可用


## 目录结构

```text
note-ai-manager/
  ├─ main.py                # FastAPI 后端与所有接口
  ├─ index.html             # 主页面（重构后的模块化前端）
  ├─ styles.css             # 样式文件
  ├─ js/                    # JavaScript 模块目录
  │  ├─ app.js              # 主应用模块
  │  ├─ api.js              # API 接口模块
  │  ├─ components.js        # UI 组件模块
  │  └─ utils.js             # 工具函数模块
  ├─ requirements.txt       # 依赖
  ├─ data/notes.db          # SQLite 数据库（首次运行自动创建）
  └─ notes/                 # Markdown 文件按分类分目录存放
```


## 环境要求

- Python 3.10 或更高版本
- Node.js 16 或更高版本（用于构建 Tailwind CSS）
- 可访问一个兼容 OpenAI 的推理服务（任选其一）：
  - 公有云：`https://api.openai.com/v1`（需要有效 Key）
  - 本地/私有：例如 Ollama、OpenAI 兼容网关，提供 `base_url` 与 `api_key`


## 快速开始

### 方法一：一键安装（推荐）
```bash
# Windows 用户
setup.bat

# Linux/Mac 用户
chmod +x setup.sh
./setup.sh
```

### 方法二：手动安装
```bash
# 1) 安装 Python 依赖
pip install -r requirements.txt

# 2) 安装 Node.js 依赖
npm install

# 3) 构建 Tailwind CSS
npm run build-css-prod

# 4) 启动服务（默认 http://127.0.0.1:8000）
python main.py
```

打开浏览器访问 `http://127.0.0.1:8000`。


## 前端使用说明

### 模块化架构
前端已重构为模块化架构，主要特点：
- **分离关注点**：HTML、CSS、JavaScript 完全分离
- **组件化设计**：可复用的 UI 组件（模态框、分页、词云等）
- **模块化 JS**：按功能拆分为独立模块，便于维护和扩展
- **响应式设计**：支持移动端和桌面端
- **Tailwind CSS**：使用本地构建的 Tailwind CSS，避免 CDN 警告

### Tailwind CSS 构建说明
项目已从 CDN 版本的 Tailwind CSS 迁移到本地构建版本：

- **开发模式**：`npm run build-css` - 监听文件变化并自动重新构建
- **生产模式**：`npm run build-css-prod` - 构建压缩版本
- **配置文件**：`tailwind.config.js` - 自定义 Tailwind 配置
- **源文件**：`src/input.css` - 包含所有自定义样式和组件
- **输出文件**：`styles.css` - 最终生成的样式文件

如需修改样式：
1. 编辑 `src/input.css` 文件
2. 运行 `npm run build-css-prod` 重新构建
3. 刷新浏览器查看效果

### 文件说明
- `index.html`：主页面，包含所有 HTML 结构
- `styles.css`：所有样式定义，包括组件样式和工具类
- `js/app.js`：主应用模块，协调各个模块
- `js/api.js`：API 接口封装，包含错误处理
- `js/components.js`：可复用组件（模态框、分页、词云等）
- `js/utils.js`：工具函数和常量定义

### 使用步骤
1. 首次进入，先在页面顶部的「API 配置」中填写：
   - API 地址（Base URL），例如：`https://api.openai.com/v1` 或你的本地服务地址
   - API Key
   - 默认模型（如 `qwen3:30b-40k`，可根据你的服务可用模型填写）
2. 登录成功后即可：
   - 新建笔记：输入正文，必要时点击「AI 优化」获取更优表达与标题，然后保存
   - 搜索与筛选：顶部搜索框，右侧词云点击可按分类或标签过滤
   - 预览/优化/更新：点击列表项打开预览，支持再次 AI 优化后保存更新
   - 全屏编辑：在预览弹窗中点击全屏按钮，进入全屏编辑模式，提供更大的编辑空间
   - 删除笔记：在预览弹窗中删除


## 后端 API 文档（简要）

> 基础地址：`/api`

- POST `/login`：保存 `api_url`、`api_key`、`model` 到 Cookie 并校验连通
  - 请求体：`{ api_url: string, api_key: string, model?: string }`
  - 响应：`{ message: "登录成功" }`

- POST `/logout`：清理会话与 Cookie
  - 响应：`{ message: "已退出登录" }`

- GET `/config`：读取当前 Cookie 配置
  - 响应：`{ api_url, api_key, logged_in, default_model }`

- POST `/note`：新建笔记（自动提取分类/标签、写入 DB 与 Markdown 文件；也可在请求体中直接指定）
  - 请求体：`{ title: string, content: string, category?: string, tags?: string }`
  - 响应：`{ message: "笔记保存成功", filename }`

- PUT `/note`：更新笔记内容/标题/分类/标签（未显式提供的字段将保留或由 AI 重新推断）
  - 请求体：`{ id: number, title?: string, content?: string, category?: string, tags?: string }`
  - 响应：`{ message: "更新成功", id }`

- DELETE `/note?id=ID`：删除笔记（数据库记录与对应文件）
  - 响应：`{ message: "已删除", id }`

- GET `/note?id=ID`：获取单条笔记详情
  - 响应：`{ id, title, content, category, tags, filename, created_at }`

- GET `/notes`：按时间倒序列出所有笔记
  - 响应：`Array<NoteMeta>`

- GET `/notes/by_category?category=名称`：按分类列出

- GET `/notes/by_tag?tag=名称`：按标签精确匹配列出

- GET `/search?query=关键词`：全文搜索（标题/内容/分类/标签）

- POST `/optimize`：AI 优化正文并生成标题，同时自动抽取分类与标签
  - 请求体：`{ content: string, prompt?: string }`
  - 响应：`{ title: string, optimized: string, category: string, tags: string[] }`
  - 说明：默认仅分析前500字符，不修改原文内容；如需修改内容，请在prompt中包含"重写"、"改写"等关键词

- GET `/categories`：返回已有分类（去重、按频次倒序）
- GET `/tags`：返回已有标签（去重、按频次倒序）


## 数据与存储

- SQLite：文件位于 `data/notes.db`（首次运行自动创建与建表）
  - 表 `notes` 字段：`id, title, content, category, tags, filename, created_at`
- Markdown 文件：保存在 `notes/分类/标题.md`
  - 文件内容：一级标题为标题，首部包含「分类、标签」信息，其后为正文
  - 更新笔记时如分类或标题变化，会自动删除旧文件并写入新路径

### AI 优化功能说明

#### 默认行为（分析模式）
- **内容分析**：仅分析笔记内容的前4000个字符
- **功能**：提取标题、分类、标签，不修改原文内容
- **适用场景**：快速获取笔记的元数据信息，保持原文完整性

#### 内容优化模式
- **触发条件**：在优化提示词中包含以下关键词之一：
  - "重写"、"改写"、"优化表达"、"润色"、"重构表述"
- **功能**：基于前4000字符分析，生成优化后的完整内容
- **适用场景**：需要AI帮助改进文章表达和结构

#### 默认优化提示词

- 文件位置：`data/prompts.txt`
- 用途：当「AI 优化」未传入自定义提示词时，后端会从该文件读取默认提示词。
- 注意：若文件不存在或为空，将回退为简短默认值「帮助用户完善笔记文档，并整理归类总结」。


## 模型与连接说明

后端通过 `openai` SDK 以「兼容 OpenAI」的方式连接任意推理服务：

- Base URL：在前端登录处填写（例如 `http://localhost:11434/v1`）
- API Key：对应服务的密钥（本地服务如允许可填任意占位符）
- 模型名：例如 `qwen3:30b-40k`，需与服务端模型一致

连通性校验：登录时会调用 `models.list()` 验证是否可用。


## 运行与调试

```bash
# 开发模式自动重载
uvicorn main:app --reload

# 指定端口
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```


## 安全与生产建议

- 更换 `main.py` 中的 `SECRET_KEY` 值并转为环境变量管理
- 生产环境使用 HTTPS，并将 Cookie `secure=True`
- 后端设置 IP 访问控制与速率限制（如 Nginx/网关层）
- 为外部 API Key 设置最小权限与定期轮换


## 常见问题（FAQ）

- Q: 登录提示「API 连接失败」？
  - A: 检查 Base URL 与 Key 是否正确，目标服务是否兼容 OpenAI，并确认模型名有效。

- Q: 本地模型怎么配？
  - A: 使用兼容网关（如 Ollama/OpenAI 兼容代理），在登录处填写其 Base URL 与 Key，并选择可用模型名即可。

- Q: 保存后未见到 Markdown 文件？
  - A: 文件写入位置为 `notes/分类/标题.md`，请确认应用进程对该目录有写权限。

- Q: 标签过滤不准？
  - A: 数据库存储为逗号分隔字符串，后端在查询后做了精确匹配过滤；若历史数据格式异常，可手动修正 `tags` 字段或重新保存一次。


## 开发者提示

### 前端开发
- 统一通过 `/api` 前缀访问后端接口
- 修改前端无需构建，刷新页面生效
- 使用 ES6 模块化，支持现代浏览器
- 组件化设计，便于复用和测试
- 响应式设计，支持移动端适配

### 后端开发
- 如需扩展字段，先更新表结构与 `Note/UpdateNoteRequest` 模型，再调整前端渲染
- `__pycache__/` 目录已在 `.gitignore` 中配置忽略，不会提交到版本控制

### 代码结构
- **模块化**：每个 JS 文件负责特定功能
- **组件化**：UI 组件可独立使用和测试
- **可维护性**：清晰的代码结构和注释
- **可扩展性**：易于添加新功能和组件


---

## 问题修复记录

### 2024-12-19 启动错误修复
- **问题**：服务器启动时出现 `FileNotFoundError: [Errno 2] No such file or directory: 'frontend.html'`
- **原因**：`main.py` 第317行引用了不存在的 `frontend.html` 文件
- **解决方案**：将文件引用从 `frontend.html` 修正为 `index.html`
- **状态**：✅ 已修复

### 2024-12-19 禁用模态框拖动功能
- **问题**：用户要求禁用模态框的拖动功能
- **原因**：模态框默认启用拖动功能，用户希望固定位置
- **解决方案**：
  - 修改 `js/components.js` 中 Modal 类的默认配置，将 `draggable` 设为 `false`
  - 修改 `js/app.js` 中模态框初始化，显式设置 `draggable: false`
  - 修改 `styles.css` 中 `.drag-handle` 样式，将 `cursor: move` 改为 `cursor: default`
- **状态**：✅ 已修复

### 2024-12-19 设置默认显示5条笔记
- **问题**：用户希望默认显示5条笔记而不是10条
- **原因**：当前分页配置默认显示10条笔记，用户希望减少到5条
- **解决方案**：
  - 修改 `js/utils.js` 中 `PAGE_SIZE` 常量从 10 改为 5
  - 修改 `js/app.js` 中分页组件的 `pageSize` 配置从 10 改为 5
  - 优化 `renderPage()` 方法，使用动态 `pageSize` 而不是硬编码值
- **状态**：✅ 已修复

### 2024-12-19 AI优化功能优化
- **问题**：用户希望AI优化默认只提取内容前500个字符用于分析，不修改笔记本身内容
- **原因**：当前AI优化会分析全部内容（最多8000字符），用户希望限制分析范围并保护原文
- **解决方案**：
  - 修改 `main.py` 中 `extract_category_and_tags` 函数，将分析内容限制为前500字符
  - 修改 `main.py` 中 `optimize_text` 函数的两个模式，都只使用前500字符进行分析
  - 保持默认模式（analyze）不修改原文内容，只提取标题、分类、标签
  - 更新 README.md 文档，详细说明AI优化功能的两种模式
- **状态**：✅ 已修复

### 2024-12-19 模型选择下拉框功能
- **问题**：用户希望默认模型可以通过下拉选择，包括 Qwen3-Next-80B-A3B-Instruct、qwen3:30b-40k 等选项
- **原因**：当前模型输入为文本框，用户希望提供预设模型选项和自定义模型功能
- **解决方案**：
  - 修改 `index.html` 中的模型输入框为下拉选择框，包含常用模型选项
  - 添加自定义模型选项，支持用户输入任意模型名称
  - 修改 `js/app.js` 中的模型处理逻辑，支持下拉选择和自定义输入切换
  - 保持后端API兼容性，无需修改后端代码
- **状态**：✅ 已修复

### 2024-12-19 页面加载时清空AI优化提示词
- **问题**：用户希望打开页面时清空所有AI优化提示词输入框
- **原因**：页面加载时AI优化提示词输入框可能保留之前的值，影响用户体验
- **解决方案**：
  - 在 `js/app.js` 中添加 `clearAIOptimizationPrompts()` 方法
  - 清空新建笔记模态框、预览笔记模态框和全屏模态框中的AI优化提示词输入框
  - 在 `loadInitialData()` 方法中调用清空方法，确保页面加载时自动清空
- **状态**：✅ 已修复

### 2024-12-19 自定义AI优化提示词支持20000字符分析
- **问题**：用户希望当输入自定义AI优化提示词时，能够分析更长的内容（20000个汉字）
- **原因**：默认只分析前4000字符，对于用户主动输入自定义提示词的情况，应该提供更全面的分析
- **解决方案**：
  - 修改 `main.py` 中的 `extract_category_and_tags` 函数，添加 `max_length` 参数
  - 修改 `optimize_text` 函数，检测是否使用自定义提示词（非默认提示词）
  - 当用户输入自定义提示词时，使用20000字符进行分析；否则使用4000字符的默认限制
  - 保持向后兼容性，不影响现有的自动分类功能
- **状态**：✅ 已修复

### 2024-12-19 调整默认分析长度为4000字符
- **问题**：用户希望将默认的分析长度从500字符调整为4000字符
- **原因**：500字符的分析长度可能不够充分，4000字符能提供更准确的分析结果
- **解决方案**：
  - 修改 `extract_category_and_tags` 函数的默认参数从500改为4000
  - 修改 `optimize_text` 函数中的默认长度设置从500改为4000
  - 保持自定义提示词时使用20000字符的逻辑不变
  - 更新相关文档说明
- **状态**：✅ 已修复

### 2024-12-19 AI优化功能404错误修复
- **问题**：用户点击笔记编辑优化时出现404错误，错误信息显示"upstream_error"
- **原因**：用户未配置AI API（api_url和api_key为空），系统尝试使用空配置调用AI服务导致404错误
- **解决方案**：
  - 修改 `main.py` 中的 `optimize_text` 函数，添加AI配置检查
  - 当未配置AI API时，返回友好的错误提示："请先配置AI API：在页面顶部填写API地址和密钥，然后点击登录"
  - 修改 `js/api.js` 中的错误处理，特殊处理AI配置相关错误
  - 提供更清晰的用户指导，避免技术性错误信息
- **状态**：✅ 已修复

### 2024-12-19 AI服务连接错误处理优化
- **问题**：用户配置了AI API但仍然出现"upstream_error"错误，错误处理逻辑不完善
- **原因**：AI服务连接失败（404、超时等）时，错误处理没有正确捕获和转换错误信息
- **解决方案**：
  - 修改 `main.py` 中 `get_ai_client` 函数的异常处理，区分不同类型的连接错误
  - 针对404和upstream_error提供"AI服务连接失败，请检查API地址是否正确"的提示
  - 针对超时错误提供"AI服务连接超时，请检查网络连接"的提示
  - 优化 `optimize_text` 函数的错误传递逻辑，确保用户看到友好的错误信息
- **状态**：✅ 已修复

### 2024-12-19 编辑模式AI优化提示词优先级修复
- **问题**：在编辑模式下，当用户输入了自定义AI优化提示词时，系统仍然优先使用默认提示词
- **原因**：前端代码中使用了 `(this.elements.optPrompt?.value.trim()) || '默认提示词'` 的逻辑，导致即使用户输入了提示词，也会被默认提示词覆盖
- **解决方案**：
  - 修改 `js/app.js` 中的 `handleOptimize` 方法，优先使用用户输入的提示词
  - 修改 `handleFullscreenOptimize` 方法，确保全屏模式也遵循相同的优先级
  - 修改 `handleNewOptimize` 方法，确保新建笔记功能也遵循相同的优先级
  - 使用更清晰的变量命名和注释，提高代码可读性
- **影响范围**：编辑模式、全屏模式、新建笔记模式的AI优化功能
- **状态**：✅ 已修复

### 2024-12-19 按钮防重复点击功能
- **问题**：用户可能快速点击按钮导致重复提交请求，影响用户体验和系统稳定性
- **原因**：所有按钮都没有防重复点击保护机制，用户可能在操作执行期间多次点击
- **解决方案**：
  - 在 `js/utils.js` 中添加 `preventDoubleClick` 和 `addPreventDoubleClick` 工具函数
  - 为所有按钮添加防重复点击保护，包括：
    - 主界面按钮：新建笔记、退出登录、清除过滤
    - 模态框按钮：保存、取消、AI优化、删除等
    - 分页按钮：上一页、下一页、页码按钮
    - 词云按钮：分类和标签过滤按钮
  - 不同操作设置不同的防重复时间：
    - 快速操作（切换、关闭）：300ms
    - 一般操作（保存、删除）：2000ms
    - AI操作（优化）：3000ms
  - 提供视觉反馈：按钮禁用状态、加载文本提示
- **技术特点**：
  - 支持异步操作（Promise）的防重复处理
  - 自动恢复按钮状态和文本
  - 错误处理和用户友好的提示信息
  - 可配置的延迟时间和加载文本
- **状态**：✅ 已修复

### 2024-12-19 Tailwind CSS CDN 警告修复
- **问题**：项目使用 Tailwind CSS CDN 版本，在生产环境中显示警告："cdn.tailwindcss.com should not be used in production"
- **原因**：Tailwind CSS 官方建议不要在生产环境使用 CDN 版本，应该使用本地构建版本
- **解决方案**：
  - 创建 `tailwind.config.js` 配置文件，指定内容扫描路径
  - 创建 `package.json` 文件，管理 Node.js 依赖
  - 创建 `src/input.css` 源文件，包含所有自定义样式和 Tailwind 指令
  - 将原有的 `styles.css` 中的自定义样式迁移到 Tailwind 组件类中
  - 修改 `index.html`，移除 CDN 引用
  - 创建构建脚本：`build-css.bat`、`build-css.sh`、`setup.bat`、`setup.sh`
  - 更新 README.md，添加 Tailwind CSS 构建说明
- **技术特点**：
  - 使用 Tailwind CLI 构建本地版本
  - 支持开发模式（监听文件变化）和生产模式（压缩输出）
  - 保持所有原有样式和功能不变
  - 提供一键安装脚本，简化部署流程
- **状态**：✅ 已修复

### 2024-12-19 AI优化功能重复点击问题修复
- **问题**：用户点击AI优化按钮时会触发两次优化，第二次会覆盖第一次的结果
- **原因**：
  - **前端问题**：`addPreventDoubleClick` 函数存在双重锁定机制冲突，内部有自己的锁定机制，但又调用了 `preventDoubleClick` 函数
  - **前端问题**：事件监听器重复绑定，每次调用都会添加新监听器但没有移除旧的
  - **前端问题**：`setLoadingState` 函数和防重复点击的按钮状态管理存在冲突
  - **后端问题**：`optimize_text` 函数会调用两次AI服务：第一次进行内容优化，第二次调用 `extract_category_and_tags` 提取分类标签
- **解决方案**：
  - **前端修复**：重构 `addPreventDoubleClick` 函数，移除双重锁定机制，统一使用单一锁定逻辑
  - **前端修复**：添加事件监听器清理机制，避免重复绑定
  - **前端修复**：移除AI优化函数中的手动 `setLoadingState` 调用，让防重复点击功能统一管理按钮状态
  - **后端修复**：将分类标签提取整合到优化过程中，避免重复调用AI服务
  - **后端优化**：在系统提示词中告知AI优先使用现有分类和标签，提高一致性
- **技术特点**：
  - 统一的防重复点击机制，避免状态冲突
  - 自动的按钮状态管理（禁用、加载文本、样式变化）
  - 支持异步操作的防重复处理
  - 后端单次AI调用完成所有优化任务，提高效率
  - 更好的用户体验和错误处理
- **影响范围**：所有AI优化按钮（新建笔记、编辑模式、全屏模式）
- **状态**：✅ 已修复

### 2024-12-19 登录状态验证修复
- **问题**：用户点击AI优化时总是提醒"优化失败，是否登录"，即使Cookie中有登录信息
- **原因**：后端的 `/api/config` 接口只检查Cookie是否存在，但没有验证Cookie中的API配置是否有效。当Cookie存在但API配置无效时，后端仍然返回 `logged_in: true`，导致前端认为已登录，但实际调用AI优化时会失败
- **解决方案**：
  - 修改后端的 `/api/config` 接口，添加API配置有效性验证
  - 只有当API配置真正有效时才返回 `logged_in: true`
  - 当API配置无效时，返回 `logged_in: false` 但保留配置信息供用户查看
- **技术特点**：
  - 真实的登录状态验证，避免Cookie存在但功能不可用的混淆情况
  - 提供更准确的用户反馈，明确区分"未登录"和"配置无效"状态
  - 保持向后兼容性，不影响现有的登录流程
- **影响范围**：所有依赖登录状态的功能（AI优化、自动分类等）
- **状态**：✅ 已修复

### 2024-12-19 AI优化提示词混合问题修复
- **问题**：当用户输入了自定义AI优化提示词时，系统仍然混合了默认的系统提示词，导致用户意图被干扰
- **原因**：在自定义提示词模式下，代码仍然在system message中包含了固定的系统提示词，然后在user message中又添加了用户的提示词，造成混合
- **解决方案**：
  - 修改 `main.py` 中的 `optimize_text` 函数，当用户提供自定义提示词时，直接使用用户提示词
  - 移除system message中的固定提示词，将用户提示词作为主要指令
  - 保留必要的JSON格式要求和现有分类标签信息，确保输出格式正确
- **技术特点**：
  - 完全尊重用户的自定义提示词，不进行任何混合或修改
  - 保持输出格式的一致性，确保前端能正确解析结果
  - 提供更纯净的AI优化体验，让用户完全控制优化方向
- **影响范围**：所有使用自定义提示词的AI优化功能
- **状态**：✅ 已修复

### 2024-12-19 全屏显示图标消失问题修复
- **问题**：用户点击全屏按钮进入全屏模式后，关闭全屏模式回到普通预览时，全屏显示图标消失了
- **原因**：`closeFullscreenModal` 方法在关闭全屏模态框时，没有确保普通模态框（`viewNoteModal`）保持打开状态，导致模态框状态管理混乱
- **解决方案**：
  - 修改 `js/app.js` 中的 `closeFullscreenModal` 方法
  - 在关闭全屏模态框时，显式设置普通模态框的 `isOpen` 状态为 `true`
  - 确保全屏按钮在关闭全屏模式后仍然可见和可用
- **技术特点**：
  - 修复模态框状态管理问题，确保状态一致性
  - 保持用户界面功能的完整性
  - 提供流畅的全屏模式切换体验
- **影响范围**：全屏显示功能
- **状态**：✅ 已修复

---

如需我继续完善自动化测试、Dockerfile、或提供一键本地模型（Ollama）对接脚本，请告诉我。


