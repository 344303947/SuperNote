<!DOCTYPE html>
<html lang="zh" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½ç¬”è®°ç®¡ç†å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    .note-card { transition: all 0.2s; }
    .note-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .tag { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; margin-right: 4px; }
    .category { font-weight: bold; color: #1e40af; }
    .search-input { border-radius: 8px; padding: 0.5em 1em; }
    /* å¯æ‹–æ‹½å¼¹çª—ï¼šä¸ºå†…å®¹å®¹å™¨è®¾ç½®ç»å¯¹å®šä½ä¸æ‹–æ‹½æ‰‹æŸ„æ ·å¼ */
    .draggable-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: default;
    }
    .drag-handle {
      cursor: move;
      user-select: none;
    }
    /* æ¨¡ç³Šæœç´¢ä¸‹æ‹‰å»ºè®® */
    .suggest-list { position: absolute; z-index: 60; background: #fff; border: 1px solid #e5e7eb; border-radius: 0.375rem; box-shadow: 0 10px 15px rgba(0,0,0,0.08); max-height: 220px; overflow-y: auto; width: 100%; }
    .suggest-item { padding: 6px 10px; font-size: 14px; cursor: pointer; }
    .suggest-item:hover { background: #f3f4f6; }
    .suggest-item.active { background: #e5f0ff; }
  </style>
</head>
<body class="h-full font-sans">

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ§  æ™ºèƒ½ç¬”è®°ç®¡ç†</h1>
      <p class="text-gray-600">AI è‡ªåŠ¨åˆ†ç±»ï¼Œè‡ªåŠ¨ä¼˜åŒ–ï¼Œä¸€é”®å­˜å‚¨ï¼Œå…¨æ–‡æœç´¢ï¼Œæ”¯æŒæœ¬åœ°éƒ¨ç½²AIæ¨¡å‹</p>
    </header>

    <!-- API é…ç½® -->
    <div id="apiConfig" class="bg-white p-6 rounded-lg shadow mb-8 border border-gray-200">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ”‘ API é…ç½®</h2>
      <form id="loginForm" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">API åœ°å€</label>
          <input type="url" id="apiUrl" placeholder="https://api.openai.com/v1" class="w-full search-input" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
          <input type="password" id="apiKey" placeholder="sk-..." class="w-full search-input" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤æ¨¡å‹</label>
          <input list="modelOptions" id="modelInput" placeholder="qwen3:30b-40k" class="w-full search-input" />
          <datalist id="modelOptions">
            <option value="qwen3:30b-40k" />
          </datalist>
        </div>
        <div class="md:col-span-2 text-right">
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">ä¿å­˜å¹¶ç™»å½•</button>
        </div>
      </form>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="hidden bg-white p-6 rounded-lg shadow">
      <div class="flex flex-col md:flex-row gap-6 mb-6">
        <div class="flex-1">
          <input type="text" id="searchInput" placeholder="æœç´¢ç¬”è®°..." class="w-full search-input" />
        </div>
        <div class="flex gap-3 items-center">
          <button id="newNoteBtn" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">æ–°å»ºç¬”è®°</button>
          <button id="logoutBtn" class="px-5 py-2 rounded-lg border text-gray-700 hover:bg-gray-100">é€€å‡ºç™»å½•</button>
        </div>
      </div>

      <!-- ä¸»ä½“ + å³ä¾§è¯äº‘ -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- åˆ—è¡¨åŒºåŸŸ -->
        <div class="md:col-span-9">
          <div id="activeFilter" class="hidden mb-3 text-sm">
            <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded">å·²æŒ‰ <span id="filterType"></span>ï¼š<span id="filterValue" class="font-semibold"></span> è¿‡æ»¤</span>
            <button id="clearFilterBtn" class="ml-2 text-blue-600 hover:underline">æ¸…é™¤è¿‡æ»¤</button>
          </div>
          <div id="noteList" class="space-y-4">
            <div class="text-gray-500 text-center py-10">æš‚æ— ç¬”è®°</div>
          </div>
          <div id="pagination" class="flex justify-center items-center gap-2 mt-4"></div>
        </div>
        <!-- å³ä¾§è¯äº‘ -->
        <aside class="md:col-span-3">
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-base font-semibold text-gray-800 mb-2">åˆ†ç±»è¯äº‘</h3>
            <div id="catCloud" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4 mt-4">
            <h3 class="text-base font-semibold text-gray-800 mb-2">æ ‡ç­¾è¯äº‘</h3>
            <div id="tagCloud" class="flex flex-wrap gap-2"></div>
          </div>
        </aside>
      </div>

      <!-- æ–°å»ºç¬”è®°æ¨¡æ€æ¡† -->
      <div id="newNoteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-6 rounded-lg w-[90vw] max-w-none max-h-[90vh] overflow-y-auto shadow-xl draggable-modal" id="newNoteModalCard">
          <div class="flex items-center justify-between drag-handle select-none">
            <h2 class="text-2xl font-bold py-2">æ–°å»ºç¬”è®°</h2>
            <button id="cancelBtn" class="ml-4 px-3 py-1 border rounded hover:bg-gray-100">å…³é—­</button>
          </div>
          <hr class="my-2" />
          <textarea id="noteContent" placeholder="è¾“å…¥ç¬”è®°å†…å®¹..." class="w-full h-64 p-2 border rounded font-mono text-sm" style="font-family: 'Courier New', monospace;"></textarea>
          <div class="mt-3 flex items-center justify-between">
            <span class="text-sm text-gray-500">æ”¯æŒ Markdown</span>
            <button id="toggleNewPreviewBtn" class="px-3 py-1 border rounded hover:bg-gray-100">é¢„è§ˆ Markdown</button>
          </div>
          <div id="notePreview" class="mt-2 p-3 border rounded bg-gray-50 hidden overflow-x-auto"></div>
          <input type="text" id="noteTitle" placeholder="ç¬”è®°æ ‡é¢˜" class="w-full mt-4 p-2 border rounded" />
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
              <input id="noteCategory" placeholder="é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±»" class="w-full p-2 border rounded" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰</label>
              <input id="noteTags" placeholder="ä¾‹å¦‚ï¼šPython, AI" class="w-full p-2 border rounded" />
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm text-gray-700 mb-2">AI ä¼˜åŒ–æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
            <input id="newOptPrompt" type="text" placeholder="å¸®åŠ©ç”¨æˆ·å®Œå–„ç¬”è®°æ–‡æ¡£ï¼Œå¹¶æ•´ç†å½’ç±»æ€»ç»“" class="w-full mb-3 p-2 border rounded" />
            <div class="flex gap-3">
              <button id="newOptimizeCombinedBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">AI ä¼˜åŒ–</button>
            </div>
            <div id="newOptStatus" class="text-sm text-gray-500 mt-2 hidden">æ­£åœ¨è°ƒç”¨ AI â€¦</div>
          </div>
          <div class="flex items-center justify-between mt-6">
            <div id="saveStatus" class="flex items-center gap-2 text-gray-500 text-sm hidden">
              <svg class="animate-spin h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              <span>æ­£åœ¨ä¿å­˜ï¼ŒAI æ­£åœ¨åˆ†æåˆ†ç±»ä¸æ ‡ç­¾ï¼Œè¯·ç¨å€™â€¦</span>
            </div>
            <div class="flex justify-end gap-3">
              <button id="cancelBtn2" class="px-4 py-2 border rounded hover:bg-gray-100">å–æ¶ˆ</button>
              <button id="saveNoteBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">ä¿å­˜</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- é¢„è§ˆç¬”è®°æ¨¡æ€æ¡† -->
      <div id="viewNoteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-6 rounded-lg w-[90vw] max-w-none max-h-[90vh] overflow-y-auto shadow-xl draggable-modal" id="viewNoteModalCard">
          <div class="flex items-start justify-between mb-2 drag-handle select-none">
            <h2 id="viewTitle" class="text-2xl font-bold text-gray-800">ç¬”è®°é¢„è§ˆ</h2>
            <button id="closeViewBtn" class="ml-4 px-3 py-1 border rounded hover:bg-gray-100">å…³é—­</button>
          </div>
          <hr class="mb-2" />
          <div class="mb-2 flex gap-2">
            <button id="toggleEditBtn" class="px-3 py-1 border rounded hover:bg-gray-100">ç¼–è¾‘æ¨¡å¼</button>
            <button id="togglePreviewBtn" class="px-3 py-1 border rounded hover:bg-gray-100 hidden">é¢„è§ˆæ¨¡å¼</button>
          </div>
          <div class="grid md:grid-cols-3 gap-3 mb-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">æ ‡é¢˜</label>
              <input id="editTitle" type="text" class="w-full p-2 border rounded" placeholder="ç¼–è¾‘æ ‡é¢˜" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">åˆ†ç±»</label>
              <input id="editCategory" class="w-full p-2 border rounded" placeholder="é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±»" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
              <input id="editTags" class="w-full p-2 border rounded" placeholder="ä¾‹å¦‚ï¼šPython, AI" />
            </div>
          </div>
          <textarea id="viewEditor" class="w-full h-64 p-2 border rounded font-mono text-sm hidden" style="font-family:'Courier New', monospace;"></textarea>
          <div id="viewPreview" class="whitespace-normal break-words bg-gray-50 p-4 rounded border text-sm overflow-x-auto"></div>
          <div class="mt-4 border-t pt-4">
            <label class="block text-sm text-gray-700 mb-2">AI ä¼˜åŒ–æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
            <input id="optPrompt" type="text" placeholder="å¸®åŠ©ç”¨æˆ·å®Œå–„ç¬”è®°æ–‡æ¡£ï¼Œå¹¶æ•´ç†å½’ç±»æ€»ç»“" class="w-full mb-3 p-2 border rounded" />
            <div class="flex gap-3">
              <button id="optimizeBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">AI ä¼˜åŒ–</button>
              <button id="saveOptimizedBtn" class="px-4 py-2 border rounded hover:bg-gray-100">ä¿å­˜æ›´æ–°</button>
              <button id="deleteNoteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">åˆ é™¤</button>
            </div>
            <div id="optStatus" class="text-sm text-gray-500 mt-2 hidden">æ­£åœ¨è°ƒç”¨ AI ä¼˜åŒ–â€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—  API é…ç½®æç¤º -->
    <div id="noConfig" class="text-center text-gray-500 py-10">
      <p>è¯·å…ˆé…ç½® OpenAI API åœ°å€å’Œ Key</p>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const PAGE_LIMIT = 20; // æ—§çš„å•æ¬¡è£å‰ªå¸¸é‡ï¼Œä¿ç•™å…¼å®¹
    const PAGE_SIZE = 10;  // åˆ†é¡µï¼šæ¯é¡µæ˜¾ç¤ºæ•°é‡
    let ALL_NOTES = [];
    let CURRENT_PAGE = 1;

    function renderMarkdown(md) {
      try { return DOMPurify.sanitize(marked.parse(md || '')); }
      catch (_) {
        return DOMPurify.sanitize((md || '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])));
      }
    }

    // å·¥å…·ï¼šä¸ºè¾“å…¥æ¡†æ·»åŠ æ¨¡ç³Šæœç´¢å»ºè®®ï¼ˆsourceGetter è¿”å›å­—ç¬¦ä¸²æ•°ç»„ï¼›isTags=true è¡¨ç¤ºä»¥é€—å·åˆ†éš”ï¼Œæ›¿æ¢æœ€åç‰‡æ®µï¼‰
    function attachFuzzySuggest(inputEl, sourceGetter, isTags=false) {
      if (!inputEl || typeof sourceGetter !== 'function') return;
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      const parent = inputEl.parentElement;
      if (parent) parent.style.position = parent.style.position || 'relative';
      const list = document.createElement('div');
      list.className = 'suggest-list hidden';
      parent.appendChild(list);
      let activeIndex = -1;

      function getQueryParts() {
        const val = (inputEl.value || '').trim();
        if (!isTags) return [val, null];
        const parts = val.split(',');
        const last = parts.pop();
        return [String(last || '').trim(), parts];
      }
      function setWithSelection(choice) {
        if (!isTags) { inputEl.value = choice; return; }
        const [_, head] = getQueryParts();
        const newVal = [...(head || []), choice].filter(s => s !== '').join(', ');
        inputEl.value = newVal;
      }
      function render(query) {
        const src = sourceGetter() || [];
        const q = (query || '').toLowerCase();
        const items = q ? src.filter(v => String(v).toLowerCase().includes(q)) : src.slice(0, 20);
        if (!items.length) { list.innerHTML = ''; list.classList.add('hidden'); activeIndex = -1; return; }
        list.innerHTML = items.slice(0, 20).map((v, i) => `<div class="suggest-item${i===0?' active':''}" data-index="${i}" data-val="${String(v).replace(/"/g,'&quot;')}">${v}</div>`).join('');
        activeIndex = 0;
        list.classList.remove('hidden');
      }
      function moveActive(delta) {
        const items = list.querySelectorAll('.suggest-item');
        if (!items.length) return;
        activeIndex = (activeIndex + delta + items.length) % items.length;
        items.forEach((el,i)=>{ el.classList.toggle('active', i===activeIndex); });
      }
      function pickActive() {
        const item = list.querySelector(`.suggest-item[data-index="${activeIndex}"]`);
        if (!item) return;
        const val = item.getAttribute('data-val') || '';
        setWithSelection(val);
        list.classList.add('hidden');
        inputEl.dispatchEvent(new Event('change'));
      }
      inputEl.addEventListener('input', () => {
        const [q] = getQueryParts();
        render(q);
      });
      inputEl.addEventListener('focus', () => {
        const [q] = getQueryParts();
        render(q);
      });
      inputEl.addEventListener('keydown', (e) => {
        if (list.classList.contains('hidden')) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); }
        else if (e.key === 'Enter') { e.preventDefault(); pickActive(); }
        else if (e.key === 'Escape') { list.classList.add('hidden'); }
      });
      document.addEventListener('click', (e) => {
        if (!list.contains(e.target) && e.target !== inputEl) list.classList.add('hidden');
      });
      list.addEventListener('click', (e) => {
        const item = e.target.closest('.suggest-item');
        if (!item) return;
        const val = item.getAttribute('data-val') || '';
        setWithSelection(val);
        list.classList.add('hidden');
        inputEl.dispatchEvent(new Event('change'));
      });
    }

    // è¯»å– Cookie é…ç½®
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    // åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", async () => {
      // æå‰åˆå§‹åŒ–æ‰€æœ‰ä¼šè¢«åç»­å‡½æ•°ä½¿ç”¨çš„ DOM å¼•ç”¨ï¼Œé¿å… TDZ é—®é¢˜
      const newNoteBtn = document.getElementById("newNoteBtn");
      const newNoteModal = document.getElementById("newNoteModal");
      const newNoteModalCard = document.getElementById("newNoteModalCard");
      const cancelBtn = document.getElementById("cancelBtn");
      const cancelBtn2 = document.getElementById("cancelBtn2");
      const saveNoteBtn = document.getElementById("saveNoteBtn");
      const saveStatus = document.getElementById("saveStatus");
      const viewNoteModal = document.getElementById("viewNoteModal");
      const viewNoteModalCard = document.getElementById("viewNoteModalCard");
      const viewTitle = document.getElementById("viewTitle");
      const viewContent = document.getElementById("viewContent");
      const closeViewBtn = document.getElementById("closeViewBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const catCloud = document.getElementById("catCloud");
      const tagCloud = document.getElementById("tagCloud");
      const activeFilter = document.getElementById("activeFilter");
      const filterType = document.getElementById("filterType");
      const filterValue = document.getElementById("filterValue");
      const clearFilterBtn = document.getElementById("clearFilterBtn");
      const optimizeBtn = document.getElementById("optimizeBtn");
      const saveOptimizedBtn = document.getElementById("saveOptimizedBtn");
      const deleteNoteBtn = document.getElementById("deleteNoteBtn");
      const optPrompt = document.getElementById("optPrompt");
      const optStatus = document.getElementById("optStatus");
      const newOptimizeCombinedBtn = document.getElementById("newOptimizeCombinedBtn");
      const newOptPrompt = document.getElementById("newOptPrompt");
      const newOptStatus = document.getElementById("newOptStatus");

      // ç¼“å­˜åˆ†ç±»/æ ‡ç­¾åˆ—è¡¨ä¾›å»ºè®®
      let cachedCategories = [];
      let cachedTags = [];

      // æ–°å»ºç¬”è®° Markdown é¢„è§ˆ
      const noteContentEl = document.getElementById("noteContent");
      const notePreviewEl = document.getElementById("notePreview");
      const toggleNewPreviewBtn = document.getElementById("toggleNewPreviewBtn");

      // é¢„è§ˆ/ç¼–è¾‘åˆ‡æ¢å…ƒç´ 
      const viewEditor = document.getElementById("viewEditor");
      const viewPreview = document.getElementById("viewPreview");
      const toggleEditBtn = document.getElementById("toggleEditBtn");
      const togglePreviewBtn = document.getElementById("togglePreviewBtn");

      // å½“å‰é¢„è§ˆå¼¹çª—çš„åŸå§‹ Markdown
      let currentViewRaw = '';

      function setViewRaw(text) {
        currentViewRaw = String(text || '');
        if (viewEditor) viewEditor.value = currentViewRaw;
        if (viewPreview) viewPreview.innerHTML = renderMarkdown(currentViewRaw);
      }
      function enterEditMode() {
        if (!viewEditor || !viewPreview) return;
        viewEditor.classList.remove('hidden');
        viewPreview.classList.add('hidden');
        if (toggleEditBtn) toggleEditBtn.classList.add('hidden');
        if (togglePreviewBtn) togglePreviewBtn.classList.remove('hidden');
      }
      function enterPreviewMode(syncFromEditor = false) {
        if (!viewEditor || !viewPreview) return;
        if (syncFromEditor) currentViewRaw = viewEditor.value || '';
        viewPreview.innerHTML = renderMarkdown(currentViewRaw);
        viewEditor.classList.add('hidden');
        viewPreview.classList.remove('hidden');
        if (toggleEditBtn) toggleEditBtn.classList.remove('hidden');
        if (togglePreviewBtn) togglePreviewBtn.classList.add('hidden');
      }
      if (toggleEditBtn) toggleEditBtn.onclick = () => enterEditMode();
      if (togglePreviewBtn) togglePreviewBtn.onclick = () => enterPreviewMode(true);

      // æ–°å»ºï¼šé¢„è§ˆåˆ‡æ¢
      if (toggleNewPreviewBtn && noteContentEl && notePreviewEl) {
        const syncNewPreview = () => { notePreviewEl.innerHTML = renderMarkdown(noteContentEl.value || ''); };
        toggleNewPreviewBtn.onclick = () => {
          const hidden = notePreviewEl.classList.contains('hidden');
          if (hidden) { syncNewPreview(); notePreviewEl.classList.remove('hidden'); toggleNewPreviewBtn.textContent = 'éšè—é¢„è§ˆ'; }
          else { notePreviewEl.classList.add('hidden'); toggleNewPreviewBtn.textContent = 'é¢„è§ˆ Markdown'; }
        };
        noteContentEl.addEventListener('input', () => {
          if (!notePreviewEl.classList.contains('hidden')) syncNewPreview();
        });
      }

      const apiConfig = getCookie("api_config");
      const apiUrl = apiConfig ? apiConfig.split('|')[0] : "";
      const apiKey = apiConfig ? apiConfig.split('|')[1] : "";

      document.getElementById("apiUrl").value = apiUrl;
      document.getElementById("apiKey").value = apiKey;

      // åŠ è½½é…ç½®
      const res = await fetch(`${API_BASE}/config`);
      const config = await res.json();
      if (config.api_url) {
        document.getElementById("apiUrl").value = config.api_url;
        document.getElementById("apiKey").value = config.api_key;
        document.getElementById("modelInput").value = config.default_model || "";
      }
      if (config.logged_in) {
        document.getElementById("apiConfig").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("noConfig").classList.add("hidden");
        await Promise.all([loadNotes(), loadStats()]);
      }

      // é‡å®šå‘
      const loginForm = document.getElementById("loginForm");
      loginForm.onsubmit = async (e) => {
        e.preventDefault();
        const url = document.getElementById("apiUrl").value.trim();
        const key = document.getElementById("apiKey").value.trim();
        const model = document.getElementById("modelInput").value.trim();
        if (!url || !key) {
          alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
          return;
        }
        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ api_url: url, api_key: key, model })
        });
        if (res.ok) {
          alert("ç™»å½•æˆåŠŸï¼");
          document.getElementById("apiConfig").classList.add("hidden");
          document.getElementById("mainApp").classList.remove("hidden");
          document.getElementById("noConfig").classList.add("hidden");
          await Promise.all([loadNotes(), loadStats()]);
        } else {
          const err = await res.json();
          alert("ç™»å½•å¤±è´¥: " + (err.error || "æœªçŸ¥é”™è¯¯"));
        }
      };

      // åˆå§‹åŒ–ä¸»ç•Œé¢

      function centerModal(cardEl) {
        if (!cardEl) return;
        cardEl.style.top = '50%';
        cardEl.style.left = '50%';
        cardEl.style.transform = 'translate(-50%, -50%)';
      }
      function makeModalDraggable(cardEl, handleEl, backdropEl) {
        if (!cardEl || !handleEl) return;
        let dragging = false;
        let startX = 0, startY = 0, origX = 0, origY = 0;
        const onMouseDown = (e) => {
          dragging = true;
          const rect = cardEl.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          origX = rect.left;
          origY = rect.top;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        };
        const onMouseMove = (e) => {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          cardEl.style.transform = 'translate(0, 0)';
          cardEl.style.left = `${origX + dx}px`;
          cardEl.style.top = `${origY + dy}px`;
        };
        const onMouseUp = () => {
          dragging = false;
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        handleEl.addEventListener('mousedown', onMouseDown);
        // ç‚¹å‡»é®ç½©å…³é—­
        if (backdropEl) {
          backdropEl.addEventListener('click', (e) => {
            if (e.target === backdropEl) {
              backdropEl.classList.add('hidden');
            }
          });
        }
      }
      newNoteBtn.onclick = () => { newNoteModal.classList.remove("hidden"); centerModal(newNoteModalCard); };
      cancelBtn.onclick = () => { newNoteModal.classList.add("hidden"); };
      if (cancelBtn2) cancelBtn2.onclick = () => { newNoteModal.classList.add("hidden"); };
      // å¯ç”¨æ‹–æ‹½ï¼ˆæ–°å»ºå¼¹çª—ï¼‰
      makeModalDraggable(newNoteModalCard, newNoteModalCard ? newNoteModalCard.querySelector('.drag-handle') : null, newNoteModal);
      saveNoteBtn.onclick = async () => {
        const title = document.getElementById("noteTitle").value.trim();
        const content = document.getElementById("noteContent").value.trim();
        const category = (document.getElementById('noteCategory')?.value || '').trim();
        const tags = (document.getElementById('noteTags')?.value || '').trim();
        if (!title || !content) {
          alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
          return;
        }
        // UI: æ˜¾ç¤ºåŠ è½½ã€ç¦ç”¨æŒ‰é’®ä¸è¾“å…¥
        const noteTitleEl = document.getElementById("noteTitle");
        const noteContentEl = document.getElementById("noteContent");
        const prevBtnText = saveNoteBtn.textContent;
        saveNoteBtn.disabled = true;
        cancelBtn.disabled = true;
        noteTitleEl.disabled = true;
        noteContentEl.disabled = true;
        saveNoteBtn.textContent = "ä¿å­˜ä¸­â€¦";
        saveNoteBtn.classList.add("opacity-60", "cursor-not-allowed");
        cancelBtn.classList.add("opacity-60", "cursor-not-allowed");
        saveStatus.classList.remove("hidden");

        try {
          const res = await fetch(`${API_BASE}/note`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content, category, tags })
          });
          if (res.ok) {
            alert("ç¬”è®°å·²ä¿å­˜ï¼");
            newNoteModal.classList.add("hidden");
            noteTitleEl.value = "";
            noteContentEl.value = "";
            const nc = document.getElementById('noteCategory');
            const nt = document.getElementById('noteTags');
            if (nc) nc.value = '';
            if (nt) nt.value = '';
            await Promise.all([loadNotes(), loadStats()]);
          } else {
            const err = await res.json().catch(() => ({}));
            alert("ä¿å­˜å¤±è´¥" + (err && err.error ? `ï¼š${err.error}` : ""));
          }
        } catch (_) {
          alert("ç½‘ç»œå¼‚å¸¸ï¼Œä¿å­˜æœªå®Œæˆï¼Œè¯·ç¨åé‡è¯•");
        } finally {
          // è¿˜åŸ UI
          saveStatus.classList.add("hidden");
          saveNoteBtn.disabled = false;
          cancelBtn.disabled = false;
          noteTitleEl.disabled = false;
          noteContentEl.disabled = false;
          saveNoteBtn.textContent = prevBtnText;
          saveNoteBtn.classList.remove("opacity-60", "cursor-not-allowed");
          cancelBtn.classList.remove("opacity-60", "cursor-not-allowed");
        }
      };

      // æ–°å»ºï¼šAI ä¼˜åŒ–å¹¶å–æ ‡é¢˜ï¼ˆåˆå¹¶ï¼‰
      if (newOptimizeCombinedBtn) {
        newOptimizeCombinedBtn.onclick = async () => {
          const noteContentEl = document.getElementById("noteContent");
          const noteTitleEl = document.getElementById("noteTitle");
          const content = noteContentEl.value || '';
          if (!content.trim()) {
            alert('è¯·å…ˆè¾“å…¥æ­£æ–‡');
            return;
          }
          const prompt = (newOptPrompt && newOptPrompt.value.trim()) || 'å¸®åŠ©ç”¨æˆ·å®Œå–„ç¬”è®°æ–‡æ¡£ï¼Œå¹¶æ•´ç†å½’ç±»æ€»ç»“';
          try {
            newOptStatus.classList.remove('hidden');
            newOptimizeCombinedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/optimize`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content, prompt })
            });
            if (!res.ok) {
              let msg = '';
              try {
                const err = await res.json();
                msg = err?.detail || err?.error || '';
              } catch (_) {
                try { msg = await res.text(); } catch (_) { msg = ''; }
              }
              alert('ä¼˜åŒ–å¤±è´¥' + (msg ? `ï¼š${msg}` : `ï¼ˆHTTP ${res.status}ï¼‰`));
              return;
            }
            const data = await res.json();
            const optimized = (data && data.optimized) || '';
            const title = (data && data.title) || '';
            const category = (data && data.category) || '';
            const tags = (data && data.tags);
            if (optimized) noteContentEl.value = optimized;
            if (title) noteTitleEl.value = title;
            const nc = document.getElementById('noteCategory');
            const nt = document.getElementById('noteTags');
            if (nc && category) nc.value = category;
            if (nt && (Array.isArray(tags) ? tags.length : (typeof tags === 'string' && tags.trim().length))) {
              nt.value = Array.isArray(tags) ? tags.join(', ') : String(tags);
            }
            // æ˜¾ç¤ºæç¤ºï¼šå·²å›å¡«åˆ†ç±»ä¸æ ‡ç­¾
            try {
              if (newOptStatus) {
                const tagStr = Array.isArray(tags) ? tags.join(', ') : (typeof tags === 'string' ? tags : '');
                newOptStatus.textContent = `å·²æå–åˆ†ç±»ï¼š${category || 'ï¼ˆæ— ï¼‰'}ï¼›æ ‡ç­¾ï¼š${tagStr || 'ï¼ˆæ— ï¼‰'}`;
                newOptStatus.classList.remove('hidden');
                setTimeout(()=>{ newOptStatus.classList.add('hidden'); }, 2500);
              }
            } catch (_) {}
          } catch (_) {
            alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¼˜åŒ–å¤±è´¥');
          } finally {
            newOptStatus.classList.add('hidden');
            newOptimizeCombinedBtn.disabled = false;
          }
        };
      }

      // å…³é—­é¢„è§ˆ
      closeViewBtn.onclick = () => { viewNoteModal.classList.add("hidden"); };
      viewNoteModal.addEventListener("click", (e) => {
        if (e.target === viewNoteModal) {
          viewNoteModal.classList.add("hidden");
        }
      });
      // å¯ç”¨æ‹–æ‹½ï¼ˆé¢„è§ˆå¼¹çª—ï¼‰å¹¶åœ¨æ‰“å¼€æ—¶å±…ä¸­
      makeModalDraggable(viewNoteModalCard, viewNoteModalCard ? viewNoteModalCard.querySelector('.drag-handle') : null, viewNoteModal);

      // é€€å‡ºç™»å½•
      logoutBtn.onclick = async () => {
        try {
          const res = await fetch(`${API_BASE}/logout`, { method: 'POST' });
          if (res.ok) {
            // åˆ‡å›ç™»å½•ç•Œé¢
            document.getElementById("mainApp").classList.add("hidden");
            document.getElementById("apiConfig").classList.remove("hidden");
            document.getElementById("noConfig").classList.remove("hidden");
            // æ¸…ç©ºè¡¨å•å¹¶èšç„¦ Key è¾“å…¥
            document.getElementById("apiUrl").value = "";
            document.getElementById("apiKey").value = "";
            const modelInput = document.getElementById("modelInput");
            if (modelInput) modelInput.value = "";
            alert("å·²é€€å‡ºç™»å½•");
            const keyEl = document.getElementById("apiKey");
            if (keyEl && keyEl.focus) keyEl.focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            alert("é€€å‡ºå¤±è´¥");
          }
        } catch (_) {
          alert("ç½‘ç»œé”™è¯¯ï¼Œé€€å‡ºå¤±è´¥");
        }
      };

      // æœç´¢
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();
        if (query.length < 1) {
          await loadNotes();
          return;
        }
        const res = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}`);
        const results = await res.json();
        setNotes(results || []);
      });

      // åŠ è½½ç¬”è®°
      async function loadNotes() {
        const res = await fetch(`${API_BASE}/notes`);
        const notes = await res.json();
        setNotes(notes || []);
      }

      function setNotes(list) {
        ALL_NOTES = Array.isArray(list) ? list : [];
        CURRENT_PAGE = 1;
        renderPage();
      }

      function renderPage() {
        const total = ALL_NOTES.length;
        const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
        const pageNotes = ALL_NOTES.slice(start, start + PAGE_SIZE);
        renderNotes(pageNotes);
        renderPagination(total);
      }

      function renderPagination(total) {
        const container = document.getElementById('pagination');
        if (!container) return;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (total === 0) { container.innerHTML = ''; return; }
        const prevDisabled = CURRENT_PAGE <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
        const nextDisabled = CURRENT_PAGE >= pages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
        const pageBtns = Array.from({ length: pages }, (_, i) => i + 1).slice(0, 100).map(p => {
          const active = p === CURRENT_PAGE ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100';
          return `<button data-page="${p}" class="px-3 py-1 border rounded ${active}">${p}</button>`;
        }).join('');
        container.innerHTML = `
          <button id="pgPrev" class="px-3 py-1 border rounded ${prevDisabled}">ä¸Šä¸€é¡µ</button>
          ${pageBtns}
          <button id="pgNext" class="px-3 py-1 border rounded ${nextDisabled}">ä¸‹ä¸€é¡µ</button>
        `;
        const prev = document.getElementById('pgPrev');
        const next = document.getElementById('pgNext');
        if (prev) prev.onclick = () => { if (CURRENT_PAGE > 1) { CURRENT_PAGE -= 1; renderPage(); } };
        if (next) next.onclick = () => { if (CURRENT_PAGE < pages) { CURRENT_PAGE += 1; renderPage(); } };
        container.querySelectorAll('button[data-page]')?.forEach(btn => {
          btn.addEventListener('click', () => {
            const p = Number(btn.getAttribute('data-page') || '1');
            if (!Number.isNaN(p)) { CURRENT_PAGE = p; renderPage(); }
          });
        });
      }

      async function loadStats() {
        const res = await fetch(`${API_BASE}/stats`);
        const data = await res.json();
        renderCloud(catCloud, data.categories || [], 'category');
        renderCloud(tagCloud, data.tags || [], 'tag');
        // åŒæ­¥ datalist ä¸ç¼“å­˜
        try {
          const [catsRes, tagsRes] = await Promise.all([
            fetch(`${API_BASE}/categories`),
            fetch(`${API_BASE}/tags`)
          ]);
          cachedCategories = catsRes.ok ? await catsRes.json() : [];
          cachedTags = tagsRes.ok ? await tagsRes.json() : [];
          const catOptions = document.getElementById('categoryOptions');
          const tagOptions = document.getElementById('tagOptions');
          if (catOptions) catOptions.innerHTML = (cachedCategories || []).map(v => `<option value="${String(v).replace(/"/g,'&quot;')}"></option>`).join('');
          if (tagOptions) tagOptions.innerHTML = (cachedTags || []).map(v => `<option value="${String(v).replace(/"/g,'&quot;')}"></option>`).join('');
        } catch (_) {}
      }

      function renderCloud(container, items, type) {
        if (!container) return;
        if (!Array.isArray(items) || items.length === 0) {
          container.innerHTML = '<div class="text-gray-400 text-sm">æš‚æ— æ•°æ®</div>';
          return;
        }
        const max = Math.max(...items.map(i => i.count));
        const min = Math.min(...items.map(i => i.count));
        const range = Math.max(1, max - min);
        container.innerHTML = items.map(i => {
          const weight = (i.count - min) / range; // 0..1
          const font = 12 + Math.round(weight * 14); // 12..26px
          const color = weight > 0.66 ? 'text-blue-700' : (weight > 0.33 ? 'text-blue-600' : 'text-blue-500');
          return `<button data-type="${type}" data-name="${i.name}" class="px-2 py-1 rounded bg-blue-50 ${color}" style="font-size:${font}px">${i.name} (${i.count})</button>`;
        }).join('');

        container.onclick = async (e) => {
          const btn = e.target.closest('button[data-type]');
          if (!btn) return;
          const name = btn.getAttribute('data-name');
          const t = btn.getAttribute('data-type');
          filterType.textContent = t === 'category' ? 'åˆ†ç±»' : 'æ ‡ç­¾';
          filterValue.textContent = name;
          activeFilter.classList.remove('hidden');
          // æ¸…ç©ºæœç´¢æ¡†ï¼Œè¿›å…¥è¿‡æ»¤æ¨¡å¼
          searchInput.value = '';
          if (t === 'category') {
            const res = await fetch(`${API_BASE}/notes/by_category?category=${encodeURIComponent(name)}`);
            const list = await res.json();
            setNotes(list || []);
          } else {
            const res = await fetch(`${API_BASE}/notes/by_tag?tag=${encodeURIComponent(name)}`);
            const list = await res.json();
            setNotes(list || []);
          }
        };
      }

      clearFilterBtn.addEventListener('click', async () => {
        activeFilter.classList.add('hidden');
        filterType.textContent = '';
        filterValue.textContent = '';
        await loadNotes();
      });

      function renderNotes(notes) {
        const list = document.getElementById("noteList");
        if (notes.length === 0) {
          list.innerHTML = '<div class="text-gray-500 text-center py-10">æš‚æ— ç¬”è®°</div>';
          return;
        }
        list.innerHTML = notes.map(note => `
          <div class="note-card border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer" data-note-id="${note.id ?? ''}" data-note-title="${(note.title || '').replace(/"/g, '&quot;')}" data-note-content="${encodeURIComponent(note.content || '')}">
            <h3 class="text-lg font-semibold text-gray-800">${note.title}</h3>
            <p class="text-sm text-gray-600 mb-2">åˆ†ç±»ï¼š <span class="category">${note.category}</span></p>
            <div class="flex flex-wrap gap-1 mb-2">
              ${(
                Array.isArray(note.tags)
                  ? note.tags
                  : (note.tags ? String(note.tags).split(',') : [])
              ).map(t => String(t).trim()).filter(t => t).map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
            <p class="text-xs text-gray-500">åˆ›å»ºäº ${new Date(note.created_at).toLocaleString()}</p>
          </div>
        `).join('');

        // ç‚¹å‡»æ‰“å¼€é¢„è§ˆï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        list.onclick = async (e) => {
          const card = e.target.closest('.note-card');
          if (!card) return;
          const noteId = card.getAttribute('data-note-id');
          const noteTitle = card.getAttribute('data-note-title') || 'ç¬”è®°é¢„è§ˆ';
          const encodedContent = card.getAttribute('data-note-content') || '';
          let contentText = '';

          if (encodedContent) {
            try { contentText = decodeURIComponent(encodedContent); } catch (_) { contentText = ''; }
          }

          let detail = null;
          if (!contentText && noteId) {
            try {
              const res = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`);
              if (res.ok) {
                detail = await res.json();
                contentText = detail.content || detail.text || '';
              }
            } catch (_) {
              // å¿½ç•¥ç½‘ç»œé”™è¯¯ï¼Œåœ¨ä¸‹æ–¹ç»™å‡ºæç¤º
            }
          }

          viewTitle.textContent = noteTitle;
          setViewRaw(contentText || 'æœªèƒ½åŠ è½½åˆ°è¯¥ç¬”è®°çš„æ­£æ–‡å†…å®¹ã€‚');
          enterPreviewMode(false);
          // è®°å½•åˆ° modal å…ƒç´ ä¸Šï¼Œä¾›åç»­ä¿å­˜ä½¿ç”¨
          viewNoteModal.setAttribute('data-note-id', noteId || '');
          viewNoteModal.setAttribute('data-note-title', noteTitle || '');
          // æ‹‰è¯¦æƒ…å¡«å……æ ‡é¢˜/åˆ†ç±»/æ ‡ç­¾
          try {
            const res2 = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`);
            if (res2.ok) {
              const detail2 = await res2.json();
              const et = document.getElementById('editTitle');
              const ec = document.getElementById('editCategory');
              const eg = document.getElementById('editTags');
              if (et) et.value = detail2?.title || noteTitle || '';
              if (ec) ec.value = detail2?.category || '';
              if (eg) eg.value = detail2?.tags || '';
            }
          } catch (_) {}
          viewNoteModal.classList.remove('hidden');
        };
      }
      // AI ä¼˜åŒ–
      if (optimizeBtn) {
        optimizeBtn.onclick = async () => {
          const content = currentViewRaw || '';
          if (!content.trim()) {
            alert('æ²¡æœ‰å¯ä¼˜åŒ–çš„å†…å®¹');
            return;
          }
          const prompt = (optPrompt && optPrompt.value.trim()) || 'å¸®åŠ©ç”¨æˆ·å®Œå–„ç¬”è®°æ–‡æ¡£ï¼Œå¹¶æ•´ç†å½’ç±»æ€»ç»“';
          try {
            optStatus.classList.remove('hidden');
            optimizeBtn.disabled = true;
            saveOptimizedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/optimize`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content, prompt })
            });
            if (!res.ok) {
              let msg = '';
              try {
                const err = await res.json();
                msg = err?.detail || err?.error || '';
              } catch (_) {
                try { msg = await res.text(); } catch (_) { msg = ''; }
              }
              alert('ä¼˜åŒ–å¤±è´¥' + (msg ? `ï¼š${msg}` : `ï¼ˆHTTP ${res.status}ï¼‰`));
              return;
            }
            const data = await res.json();
            const optimized = (data && data.optimized) || '';
            const category = (data && data.category) || '';
            const tags = (data && data.tags);
            if (optimized) {
              setViewRaw(optimized);
              saveOptimizedBtn.disabled = false;
              enterPreviewMode(false);
            }
            // å›å¡«åˆ†ç±»/æ ‡ç­¾ï¼ˆç¼–è¾‘åŒºï¼‰
            const ec = document.getElementById('editCategory');
            const eg = document.getElementById('editTags');
            if (ec && category) ec.value = category;
            if (eg && (Array.isArray(tags) ? tags.length : (typeof tags === 'string' && tags.trim().length))) {
              eg.value = Array.isArray(tags) ? tags.join(', ') : String(tags);
            }
            // æç¤º
            try {
              if (optStatus) {
                const tagStr = Array.isArray(tags) ? tags.join(', ') : (typeof tags === 'string' ? tags : '');
                optStatus.textContent = `å·²æå–åˆ†ç±»ï¼š${category || 'ï¼ˆæ— ï¼‰'}ï¼›æ ‡ç­¾ï¼š${tagStr || 'ï¼ˆæ— ï¼‰'}`;
                optStatus.classList.remove('hidden');
                setTimeout(()=>{ optStatus.classList.add('hidden'); }, 2500);
              }
            } catch (_) {}
          } catch (e) {
            alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¼˜åŒ–å¤±è´¥');
          } finally {
            optStatus.classList.add('hidden');
            optimizeBtn.disabled = false;
          }
        };
      }

      // ä¿å­˜ä¼˜åŒ–åçš„æ›´æ–°
      if (saveOptimizedBtn) {
        // ä»»æ„ç¼–è¾‘å˜æ›´å³å…è®¸ä¿å­˜
        ['input','change','keyup'].forEach(evt => {
          if (viewEditor) viewEditor.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          const et = document.getElementById('editTitle');
          const ec = document.getElementById('editCategory');
          const eg = document.getElementById('editTags');
          if (et) et.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          if (ec) ec.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          if (eg) eg.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
        });

        saveOptimizedBtn.onclick = async () => {
          const noteId = viewNoteModal.getAttribute('data-note-id');
          if (!noteId) {
            alert('æœªè·å–åˆ°ç¬”è®° IDï¼Œæ— æ³•ä¿å­˜');
            return;
          }
          const title = (document.getElementById('editTitle')?.value || viewNoteModal.getAttribute('data-note-title') || '').trim();
          const category = (document.getElementById('editCategory')?.value || '').trim();
          const tags = (document.getElementById('editTags')?.value || '').trim();
          // è‹¥åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œä¼˜å…ˆä»ç¼–è¾‘å™¨å–å€¼ï¼Œå¹¶åŒæ­¥åˆ°é¢„è§ˆåŸæ–‡
          let content = currentViewRaw || '';
          if (viewEditor && !viewEditor.classList.contains('hidden')) {
            content = viewEditor.value || '';
            currentViewRaw = content;
          }
          try {
            saveOptimizedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/note`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: Number(noteId), title, content, category, tags })
            });
            if (res.ok) {
              alert('å·²ä¿å­˜ä¼˜åŒ–/ç¼–è¾‘ç»“æœ');
              await Promise.all([loadNotes(), loadStats()]);
              viewNoteModal.classList.add('hidden');
            } else {
              const err = await res.json().catch(() => ({}));
              alert('ä¿å­˜å¤±è´¥' + (err && err.detail ? `ï¼š${err.detail}` : ''));
            }
          } catch (_) {
            alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¿å­˜å¤±è´¥');
          } finally {
            saveOptimizedBtn.disabled = false;
          }
        };
      }

      // åˆ é™¤ç¬”è®°
      if (deleteNoteBtn) {
        deleteNoteBtn.onclick = async () => {
          const noteId = viewNoteModal.getAttribute('data-note-id');
          if (!noteId) {
            alert('æœªè·å–åˆ°ç¬”è®° IDï¼Œæ— æ³•åˆ é™¤');
            return;
          }
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
          try {
            const res = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`, { method: 'DELETE' });
            if (res.ok) {
              alert('å·²åˆ é™¤');
              await Promise.all([loadNotes(), loadStats()]);
              viewNoteModal.classList.add('hidden');
            } else {
              let msg = '';
              try { const err = await res.json(); msg = err?.detail || err?.error || ''; } catch(_) {}
              alert('åˆ é™¤å¤±è´¥' + (msg ? `ï¼š${msg}` : `ï¼ˆHTTP ${res.status}ï¼‰`));
            }
          } catch (_) {
            alert('ç½‘ç»œå¼‚å¸¸ï¼Œåˆ é™¤å¤±è´¥');
          }
        };
      }

      // åˆå§‹åŠ è½½
      await loadNotes();

      // ç»‘å®šæ¨¡ç³Šå»ºè®®åˆ°è¾“å…¥æ¡†
      attachFuzzySuggest(document.getElementById('noteCategory'), () => cachedCategories, false);
      attachFuzzySuggest(document.getElementById('editCategory'), () => cachedCategories, false);
      attachFuzzySuggest(document.getElementById('noteTags'), () => cachedTags, true);
      attachFuzzySuggest(document.getElementById('editTags'), () => cachedTags, true);
    });
  </script>
</body>
</html>