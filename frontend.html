<!DOCTYPE html>
<html lang="zh" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>智能笔记管理器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    .note-card { transition: all 0.2s; }
    .note-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .tag { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; margin-right: 4px; }
    .category { font-weight: bold; color: #1e40af; }
    .search-input { border-radius: 8px; padding: 0.5em 1em; }
    /* 可拖拽弹窗：为内容容器设置绝对定位与拖拽手柄样式 */
    .draggable-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: default;
    }
    .drag-handle {
      cursor: move;
      user-select: none;
    }
    /* 模糊搜索下拉建议 */
    .suggest-list { position: absolute; z-index: 60; background: #fff; border: 1px solid #e5e7eb; border-radius: 0.375rem; box-shadow: 0 10px 15px rgba(0,0,0,0.08); max-height: 220px; overflow-y: auto; width: 100%; }
    .suggest-item { padding: 6px 10px; font-size: 14px; cursor: pointer; }
    .suggest-item:hover { background: #f3f4f6; }
    .suggest-item.active { background: #e5f0ff; }
  </style>
</head>
<body class="h-full font-sans">

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">🧠 智能笔记管理</h1>
      <p class="text-gray-600">AI 自动分类，自动优化，一键存储，全文搜索，支持本地部署AI模型</p>
    </header>

    <!-- API 配置 -->
    <div id="apiConfig" class="bg-white p-6 rounded-lg shadow mb-8 border border-gray-200">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">🔑 API 配置</h2>
      <form id="loginForm" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">API 地址</label>
          <input type="url" id="apiUrl" placeholder="https://api.openai.com/v1" class="w-full search-input" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
          <input type="password" id="apiKey" placeholder="sk-..." class="w-full search-input" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">默认模型</label>
          <input list="modelOptions" id="modelInput" placeholder="qwen3:30b-40k" class="w-full search-input" />
          <datalist id="modelOptions">
            <option value="qwen3:30b-40k" />
          </datalist>
        </div>
        <div class="md:col-span-2 text-right">
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">保存并登录</button>
        </div>
      </form>
    </div>

    <!-- 主界面 -->
    <div id="mainApp" class="hidden bg-white p-6 rounded-lg shadow">
      <div class="flex flex-col md:flex-row gap-6 mb-6">
        <div class="flex-1">
          <input type="text" id="searchInput" placeholder="搜索笔记..." class="w-full search-input" />
        </div>
        <div class="flex gap-3 items-center">
          <button id="newNoteBtn" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">新建笔记</button>
          <button id="logoutBtn" class="px-5 py-2 rounded-lg border text-gray-700 hover:bg-gray-100">退出登录</button>
        </div>
      </div>

      <!-- 主体 + 右侧词云 -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- 列表区域 -->
        <div class="md:col-span-9">
          <div id="activeFilter" class="hidden mb-3 text-sm">
            <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded">已按 <span id="filterType"></span>：<span id="filterValue" class="font-semibold"></span> 过滤</span>
            <button id="clearFilterBtn" class="ml-2 text-blue-600 hover:underline">清除过滤</button>
          </div>
          <div id="noteList" class="space-y-4">
            <div class="text-gray-500 text-center py-10">暂无笔记</div>
          </div>
          <div id="pagination" class="flex justify-center items-center gap-2 mt-4"></div>
        </div>
        <!-- 右侧词云 -->
        <aside class="md:col-span-3">
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-base font-semibold text-gray-800 mb-2">分类词云</h3>
            <div id="catCloud" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4 mt-4">
            <h3 class="text-base font-semibold text-gray-800 mb-2">标签词云</h3>
            <div id="tagCloud" class="flex flex-wrap gap-2"></div>
          </div>
        </aside>
      </div>

      <!-- 新建笔记模态框 -->
      <div id="newNoteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-6 rounded-lg w-[90vw] max-w-none max-h-[90vh] overflow-y-auto shadow-xl draggable-modal" id="newNoteModalCard">
          <div class="flex items-center justify-between drag-handle select-none">
            <h2 class="text-2xl font-bold py-2">新建笔记</h2>
            <button id="cancelBtn" class="ml-4 px-3 py-1 border rounded hover:bg-gray-100">关闭</button>
          </div>
          <hr class="my-2" />
          <textarea id="noteContent" placeholder="输入笔记内容..." class="w-full h-64 p-2 border rounded font-mono text-sm" style="font-family: 'Courier New', monospace;"></textarea>
          <div class="mt-3 flex items-center justify-between">
            <span class="text-sm text-gray-500">支持 Markdown</span>
            <button id="toggleNewPreviewBtn" class="px-3 py-1 border rounded hover:bg-gray-100">预览 Markdown</button>
          </div>
          <div id="notePreview" class="mt-2 p-3 border rounded bg-gray-50 hidden overflow-x-auto"></div>
          <input type="text" id="noteTitle" placeholder="笔记标题" class="w-full mt-4 p-2 border rounded" />
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">分类（可选）</label>
              <input id="noteCategory" placeholder="选择或输入分类" class="w-full p-2 border rounded" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">标签（可选，逗号分隔）</label>
              <input id="noteTags" placeholder="例如：Python, AI" class="w-full p-2 border rounded" />
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm text-gray-700 mb-2">AI 优化提示词（可选）</label>
            <input id="newOptPrompt" type="text" placeholder="帮助用户完善笔记文档，并整理归类总结" class="w-full mb-3 p-2 border rounded" />
            <div class="flex gap-3">
              <button id="newOptimizeCombinedBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">AI 优化</button>
            </div>
            <div id="newOptStatus" class="text-sm text-gray-500 mt-2 hidden">正在调用 AI …</div>
          </div>
          <div class="flex items-center justify-between mt-6">
            <div id="saveStatus" class="flex items-center gap-2 text-gray-500 text-sm hidden">
              <svg class="animate-spin h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              <span>正在保存，AI 正在分析分类与标签，请稍候…</span>
            </div>
            <div class="flex justify-end gap-3">
              <button id="cancelBtn2" class="px-4 py-2 border rounded hover:bg-gray-100">取消</button>
              <button id="saveNoteBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">保存</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 预览笔记模态框 -->
      <div id="viewNoteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-6 rounded-lg w-[90vw] max-w-none max-h-[90vh] overflow-y-auto shadow-xl draggable-modal" id="viewNoteModalCard">
          <div class="flex items-start justify-between mb-2 drag-handle select-none">
            <h2 id="viewTitle" class="text-2xl font-bold text-gray-800">笔记预览</h2>
            <button id="closeViewBtn" class="ml-4 px-3 py-1 border rounded hover:bg-gray-100">关闭</button>
          </div>
          <hr class="mb-2" />
          <div class="mb-2 flex gap-2">
            <button id="toggleEditBtn" class="px-3 py-1 border rounded hover:bg-gray-100">编辑模式</button>
            <button id="togglePreviewBtn" class="px-3 py-1 border rounded hover:bg-gray-100 hidden">预览模式</button>
          </div>
          <div class="grid md:grid-cols-3 gap-3 mb-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">标题</label>
              <input id="editTitle" type="text" class="w-full p-2 border rounded" placeholder="编辑标题" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">分类</label>
              <input id="editCategory" class="w-full p-2 border rounded" placeholder="选择或输入分类" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">标签（逗号分隔）</label>
              <input id="editTags" class="w-full p-2 border rounded" placeholder="例如：Python, AI" />
            </div>
          </div>
          <textarea id="viewEditor" class="w-full h-64 p-2 border rounded font-mono text-sm hidden" style="font-family:'Courier New', monospace;"></textarea>
          <div id="viewPreview" class="whitespace-normal break-words bg-gray-50 p-4 rounded border text-sm overflow-x-auto"></div>
          <div class="mt-4 border-t pt-4">
            <label class="block text-sm text-gray-700 mb-2">AI 优化提示词（可选）</label>
            <input id="optPrompt" type="text" placeholder="帮助用户完善笔记文档，并整理归类总结" class="w-full mb-3 p-2 border rounded" />
            <div class="flex gap-3">
              <button id="optimizeBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">AI 优化</button>
              <button id="saveOptimizedBtn" class="px-4 py-2 border rounded hover:bg-gray-100">保存更新</button>
              <button id="deleteNoteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">删除</button>
            </div>
            <div id="optStatus" class="text-sm text-gray-500 mt-2 hidden">正在调用 AI 优化…</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 无 API 配置提示 -->
    <div id="noConfig" class="text-center text-gray-500 py-10">
      <p>请先配置 OpenAI API 地址和 Key</p>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const PAGE_LIMIT = 20; // 旧的单次裁剪常量，保留兼容
    const PAGE_SIZE = 10;  // 分页：每页显示数量
    let ALL_NOTES = [];
    let CURRENT_PAGE = 1;

    function renderMarkdown(md) {
      try { return DOMPurify.sanitize(marked.parse(md || '')); }
      catch (_) {
        return DOMPurify.sanitize((md || '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])));
      }
    }

    // 工具：为输入框添加模糊搜索建议（sourceGetter 返回字符串数组；isTags=true 表示以逗号分隔，替换最后片段）
    function attachFuzzySuggest(inputEl, sourceGetter, isTags=false) {
      if (!inputEl || typeof sourceGetter !== 'function') return;
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      const parent = inputEl.parentElement;
      if (parent) parent.style.position = parent.style.position || 'relative';
      const list = document.createElement('div');
      list.className = 'suggest-list hidden';
      parent.appendChild(list);
      let activeIndex = -1;

      function getQueryParts() {
        const val = (inputEl.value || '').trim();
        if (!isTags) return [val, null];
        const parts = val.split(',');
        const last = parts.pop();
        return [String(last || '').trim(), parts];
      }
      function setWithSelection(choice) {
        if (!isTags) { inputEl.value = choice; return; }
        const [_, head] = getQueryParts();
        const newVal = [...(head || []), choice].filter(s => s !== '').join(', ');
        inputEl.value = newVal;
      }
      function render(query) {
        const src = sourceGetter() || [];
        const q = (query || '').toLowerCase();
        const items = q ? src.filter(v => String(v).toLowerCase().includes(q)) : src.slice(0, 20);
        if (!items.length) { list.innerHTML = ''; list.classList.add('hidden'); activeIndex = -1; return; }
        list.innerHTML = items.slice(0, 20).map((v, i) => `<div class="suggest-item${i===0?' active':''}" data-index="${i}" data-val="${String(v).replace(/"/g,'&quot;')}">${v}</div>`).join('');
        activeIndex = 0;
        list.classList.remove('hidden');
      }
      function moveActive(delta) {
        const items = list.querySelectorAll('.suggest-item');
        if (!items.length) return;
        activeIndex = (activeIndex + delta + items.length) % items.length;
        items.forEach((el,i)=>{ el.classList.toggle('active', i===activeIndex); });
      }
      function pickActive() {
        const item = list.querySelector(`.suggest-item[data-index="${activeIndex}"]`);
        if (!item) return;
        const val = item.getAttribute('data-val') || '';
        setWithSelection(val);
        list.classList.add('hidden');
        inputEl.dispatchEvent(new Event('change'));
      }
      inputEl.addEventListener('input', () => {
        const [q] = getQueryParts();
        render(q);
      });
      inputEl.addEventListener('focus', () => {
        const [q] = getQueryParts();
        render(q);
      });
      inputEl.addEventListener('keydown', (e) => {
        if (list.classList.contains('hidden')) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); }
        else if (e.key === 'Enter') { e.preventDefault(); pickActive(); }
        else if (e.key === 'Escape') { list.classList.add('hidden'); }
      });
      document.addEventListener('click', (e) => {
        if (!list.contains(e.target) && e.target !== inputEl) list.classList.add('hidden');
      });
      list.addEventListener('click', (e) => {
        const item = e.target.closest('.suggest-item');
        if (!item) return;
        const val = item.getAttribute('data-val') || '';
        setWithSelection(val);
        list.classList.add('hidden');
        inputEl.dispatchEvent(new Event('change'));
      });
    }

    // 读取 Cookie 配置
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    // 初始化
    document.addEventListener("DOMContentLoaded", async () => {
      // 提前初始化所有会被后续函数使用的 DOM 引用，避免 TDZ 问题
      const newNoteBtn = document.getElementById("newNoteBtn");
      const newNoteModal = document.getElementById("newNoteModal");
      const newNoteModalCard = document.getElementById("newNoteModalCard");
      const cancelBtn = document.getElementById("cancelBtn");
      const cancelBtn2 = document.getElementById("cancelBtn2");
      const saveNoteBtn = document.getElementById("saveNoteBtn");
      const saveStatus = document.getElementById("saveStatus");
      const viewNoteModal = document.getElementById("viewNoteModal");
      const viewNoteModalCard = document.getElementById("viewNoteModalCard");
      const viewTitle = document.getElementById("viewTitle");
      const viewContent = document.getElementById("viewContent");
      const closeViewBtn = document.getElementById("closeViewBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const catCloud = document.getElementById("catCloud");
      const tagCloud = document.getElementById("tagCloud");
      const activeFilter = document.getElementById("activeFilter");
      const filterType = document.getElementById("filterType");
      const filterValue = document.getElementById("filterValue");
      const clearFilterBtn = document.getElementById("clearFilterBtn");
      const optimizeBtn = document.getElementById("optimizeBtn");
      const saveOptimizedBtn = document.getElementById("saveOptimizedBtn");
      const deleteNoteBtn = document.getElementById("deleteNoteBtn");
      const optPrompt = document.getElementById("optPrompt");
      const optStatus = document.getElementById("optStatus");
      const newOptimizeCombinedBtn = document.getElementById("newOptimizeCombinedBtn");
      const newOptPrompt = document.getElementById("newOptPrompt");
      const newOptStatus = document.getElementById("newOptStatus");

      // 缓存分类/标签列表供建议
      let cachedCategories = [];
      let cachedTags = [];

      // 新建笔记 Markdown 预览
      const noteContentEl = document.getElementById("noteContent");
      const notePreviewEl = document.getElementById("notePreview");
      const toggleNewPreviewBtn = document.getElementById("toggleNewPreviewBtn");

      // 预览/编辑切换元素
      const viewEditor = document.getElementById("viewEditor");
      const viewPreview = document.getElementById("viewPreview");
      const toggleEditBtn = document.getElementById("toggleEditBtn");
      const togglePreviewBtn = document.getElementById("togglePreviewBtn");

      // 当前预览弹窗的原始 Markdown
      let currentViewRaw = '';

      function setViewRaw(text) {
        currentViewRaw = String(text || '');
        if (viewEditor) viewEditor.value = currentViewRaw;
        if (viewPreview) viewPreview.innerHTML = renderMarkdown(currentViewRaw);
      }
      function enterEditMode() {
        if (!viewEditor || !viewPreview) return;
        viewEditor.classList.remove('hidden');
        viewPreview.classList.add('hidden');
        if (toggleEditBtn) toggleEditBtn.classList.add('hidden');
        if (togglePreviewBtn) togglePreviewBtn.classList.remove('hidden');
      }
      function enterPreviewMode(syncFromEditor = false) {
        if (!viewEditor || !viewPreview) return;
        if (syncFromEditor) currentViewRaw = viewEditor.value || '';
        viewPreview.innerHTML = renderMarkdown(currentViewRaw);
        viewEditor.classList.add('hidden');
        viewPreview.classList.remove('hidden');
        if (toggleEditBtn) toggleEditBtn.classList.remove('hidden');
        if (togglePreviewBtn) togglePreviewBtn.classList.add('hidden');
      }
      if (toggleEditBtn) toggleEditBtn.onclick = () => enterEditMode();
      if (togglePreviewBtn) togglePreviewBtn.onclick = () => enterPreviewMode(true);

      // 新建：预览切换
      if (toggleNewPreviewBtn && noteContentEl && notePreviewEl) {
        const syncNewPreview = () => { notePreviewEl.innerHTML = renderMarkdown(noteContentEl.value || ''); };
        toggleNewPreviewBtn.onclick = () => {
          const hidden = notePreviewEl.classList.contains('hidden');
          if (hidden) { syncNewPreview(); notePreviewEl.classList.remove('hidden'); toggleNewPreviewBtn.textContent = '隐藏预览'; }
          else { notePreviewEl.classList.add('hidden'); toggleNewPreviewBtn.textContent = '预览 Markdown'; }
        };
        noteContentEl.addEventListener('input', () => {
          if (!notePreviewEl.classList.contains('hidden')) syncNewPreview();
        });
      }

      const apiConfig = getCookie("api_config");
      const apiUrl = apiConfig ? apiConfig.split('|')[0] : "";
      const apiKey = apiConfig ? apiConfig.split('|')[1] : "";

      document.getElementById("apiUrl").value = apiUrl;
      document.getElementById("apiKey").value = apiKey;

      // 加载配置
      const res = await fetch(`${API_BASE}/config`);
      const config = await res.json();
      if (config.api_url) {
        document.getElementById("apiUrl").value = config.api_url;
        document.getElementById("apiKey").value = config.api_key;
        document.getElementById("modelInput").value = config.default_model || "";
      }
      if (config.logged_in) {
        document.getElementById("apiConfig").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("noConfig").classList.add("hidden");
        await Promise.all([loadNotes(), loadStats()]);
      }

      // 重定向
      const loginForm = document.getElementById("loginForm");
      loginForm.onsubmit = async (e) => {
        e.preventDefault();
        const url = document.getElementById("apiUrl").value.trim();
        const key = document.getElementById("apiKey").value.trim();
        const model = document.getElementById("modelInput").value.trim();
        if (!url || !key) {
          alert("请填写完整信息");
          return;
        }
        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ api_url: url, api_key: key, model })
        });
        if (res.ok) {
          alert("登录成功！");
          document.getElementById("apiConfig").classList.add("hidden");
          document.getElementById("mainApp").classList.remove("hidden");
          document.getElementById("noConfig").classList.add("hidden");
          await Promise.all([loadNotes(), loadStats()]);
        } else {
          const err = await res.json();
          alert("登录失败: " + (err.error || "未知错误"));
        }
      };

      // 初始化主界面

      function centerModal(cardEl) {
        if (!cardEl) return;
        cardEl.style.top = '50%';
        cardEl.style.left = '50%';
        cardEl.style.transform = 'translate(-50%, -50%)';
      }
      function makeModalDraggable(cardEl, handleEl, backdropEl) {
        if (!cardEl || !handleEl) return;
        let dragging = false;
        let startX = 0, startY = 0, origX = 0, origY = 0;
        const onMouseDown = (e) => {
          dragging = true;
          const rect = cardEl.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          origX = rect.left;
          origY = rect.top;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        };
        const onMouseMove = (e) => {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          cardEl.style.transform = 'translate(0, 0)';
          cardEl.style.left = `${origX + dx}px`;
          cardEl.style.top = `${origY + dy}px`;
        };
        const onMouseUp = () => {
          dragging = false;
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        handleEl.addEventListener('mousedown', onMouseDown);
        // 点击遮罩关闭
        if (backdropEl) {
          backdropEl.addEventListener('click', (e) => {
            if (e.target === backdropEl) {
              backdropEl.classList.add('hidden');
            }
          });
        }
      }
      newNoteBtn.onclick = () => { newNoteModal.classList.remove("hidden"); centerModal(newNoteModalCard); };
      cancelBtn.onclick = () => { newNoteModal.classList.add("hidden"); };
      if (cancelBtn2) cancelBtn2.onclick = () => { newNoteModal.classList.add("hidden"); };
      // 启用拖拽（新建弹窗）
      makeModalDraggable(newNoteModalCard, newNoteModalCard ? newNoteModalCard.querySelector('.drag-handle') : null, newNoteModal);
      saveNoteBtn.onclick = async () => {
        const title = document.getElementById("noteTitle").value.trim();
        const content = document.getElementById("noteContent").value.trim();
        const category = (document.getElementById('noteCategory')?.value || '').trim();
        const tags = (document.getElementById('noteTags')?.value || '').trim();
        if (!title || !content) {
          alert("标题和内容不能为空");
          return;
        }
        // UI: 显示加载、禁用按钮与输入
        const noteTitleEl = document.getElementById("noteTitle");
        const noteContentEl = document.getElementById("noteContent");
        const prevBtnText = saveNoteBtn.textContent;
        saveNoteBtn.disabled = true;
        cancelBtn.disabled = true;
        noteTitleEl.disabled = true;
        noteContentEl.disabled = true;
        saveNoteBtn.textContent = "保存中…";
        saveNoteBtn.classList.add("opacity-60", "cursor-not-allowed");
        cancelBtn.classList.add("opacity-60", "cursor-not-allowed");
        saveStatus.classList.remove("hidden");

        try {
          const res = await fetch(`${API_BASE}/note`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content, category, tags })
          });
          if (res.ok) {
            alert("笔记已保存！");
            newNoteModal.classList.add("hidden");
            noteTitleEl.value = "";
            noteContentEl.value = "";
            const nc = document.getElementById('noteCategory');
            const nt = document.getElementById('noteTags');
            if (nc) nc.value = '';
            if (nt) nt.value = '';
            await Promise.all([loadNotes(), loadStats()]);
          } else {
            const err = await res.json().catch(() => ({}));
            alert("保存失败" + (err && err.error ? `：${err.error}` : ""));
          }
        } catch (_) {
          alert("网络异常，保存未完成，请稍后重试");
        } finally {
          // 还原 UI
          saveStatus.classList.add("hidden");
          saveNoteBtn.disabled = false;
          cancelBtn.disabled = false;
          noteTitleEl.disabled = false;
          noteContentEl.disabled = false;
          saveNoteBtn.textContent = prevBtnText;
          saveNoteBtn.classList.remove("opacity-60", "cursor-not-allowed");
          cancelBtn.classList.remove("opacity-60", "cursor-not-allowed");
        }
      };

      // 新建：AI 优化并取标题（合并）
      if (newOptimizeCombinedBtn) {
        newOptimizeCombinedBtn.onclick = async () => {
          const noteContentEl = document.getElementById("noteContent");
          const noteTitleEl = document.getElementById("noteTitle");
          const content = noteContentEl.value || '';
          if (!content.trim()) {
            alert('请先输入正文');
            return;
          }
          const prompt = (newOptPrompt && newOptPrompt.value.trim()) || '帮助用户完善笔记文档，并整理归类总结';
          try {
            newOptStatus.classList.remove('hidden');
            newOptimizeCombinedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/optimize`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content, prompt })
            });
            if (!res.ok) {
              let msg = '';
              try {
                const err = await res.json();
                msg = err?.detail || err?.error || '';
              } catch (_) {
                try { msg = await res.text(); } catch (_) { msg = ''; }
              }
              alert('优化失败' + (msg ? `：${msg}` : `（HTTP ${res.status}）`));
              return;
            }
            const data = await res.json();
            const optimized = (data && data.optimized) || '';
            const title = (data && data.title) || '';
            const category = (data && data.category) || '';
            const tags = (data && data.tags);
            if (optimized) noteContentEl.value = optimized;
            if (title) noteTitleEl.value = title;
            const nc = document.getElementById('noteCategory');
            const nt = document.getElementById('noteTags');
            if (nc && category) nc.value = category;
            if (nt && (Array.isArray(tags) ? tags.length : (typeof tags === 'string' && tags.trim().length))) {
              nt.value = Array.isArray(tags) ? tags.join(', ') : String(tags);
            }
            // 显示提示：已回填分类与标签
            try {
              if (newOptStatus) {
                const tagStr = Array.isArray(tags) ? tags.join(', ') : (typeof tags === 'string' ? tags : '');
                newOptStatus.textContent = `已提取分类：${category || '（无）'}；标签：${tagStr || '（无）'}`;
                newOptStatus.classList.remove('hidden');
                setTimeout(()=>{ newOptStatus.classList.add('hidden'); }, 2500);
              }
            } catch (_) {}
          } catch (_) {
            alert('网络异常，优化失败');
          } finally {
            newOptStatus.classList.add('hidden');
            newOptimizeCombinedBtn.disabled = false;
          }
        };
      }

      // 关闭预览
      closeViewBtn.onclick = () => { viewNoteModal.classList.add("hidden"); };
      viewNoteModal.addEventListener("click", (e) => {
        if (e.target === viewNoteModal) {
          viewNoteModal.classList.add("hidden");
        }
      });
      // 启用拖拽（预览弹窗）并在打开时居中
      makeModalDraggable(viewNoteModalCard, viewNoteModalCard ? viewNoteModalCard.querySelector('.drag-handle') : null, viewNoteModal);

      // 退出登录
      logoutBtn.onclick = async () => {
        try {
          const res = await fetch(`${API_BASE}/logout`, { method: 'POST' });
          if (res.ok) {
            // 切回登录界面
            document.getElementById("mainApp").classList.add("hidden");
            document.getElementById("apiConfig").classList.remove("hidden");
            document.getElementById("noConfig").classList.remove("hidden");
            // 清空表单并聚焦 Key 输入
            document.getElementById("apiUrl").value = "";
            document.getElementById("apiKey").value = "";
            const modelInput = document.getElementById("modelInput");
            if (modelInput) modelInput.value = "";
            alert("已退出登录");
            const keyEl = document.getElementById("apiKey");
            if (keyEl && keyEl.focus) keyEl.focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            alert("退出失败");
          }
        } catch (_) {
          alert("网络错误，退出失败");
        }
      };

      // 搜索
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();
        if (query.length < 1) {
          await loadNotes();
          return;
        }
        const res = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}`);
        const results = await res.json();
        setNotes(results || []);
      });

      // 加载笔记
      async function loadNotes() {
        const res = await fetch(`${API_BASE}/notes`);
        const notes = await res.json();
        setNotes(notes || []);
      }

      function setNotes(list) {
        ALL_NOTES = Array.isArray(list) ? list : [];
        CURRENT_PAGE = 1;
        renderPage();
      }

      function renderPage() {
        const total = ALL_NOTES.length;
        const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
        const pageNotes = ALL_NOTES.slice(start, start + PAGE_SIZE);
        renderNotes(pageNotes);
        renderPagination(total);
      }

      function renderPagination(total) {
        const container = document.getElementById('pagination');
        if (!container) return;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (total === 0) { container.innerHTML = ''; return; }
        const prevDisabled = CURRENT_PAGE <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
        const nextDisabled = CURRENT_PAGE >= pages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
        const pageBtns = Array.from({ length: pages }, (_, i) => i + 1).slice(0, 100).map(p => {
          const active = p === CURRENT_PAGE ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100';
          return `<button data-page="${p}" class="px-3 py-1 border rounded ${active}">${p}</button>`;
        }).join('');
        container.innerHTML = `
          <button id="pgPrev" class="px-3 py-1 border rounded ${prevDisabled}">上一页</button>
          ${pageBtns}
          <button id="pgNext" class="px-3 py-1 border rounded ${nextDisabled}">下一页</button>
        `;
        const prev = document.getElementById('pgPrev');
        const next = document.getElementById('pgNext');
        if (prev) prev.onclick = () => { if (CURRENT_PAGE > 1) { CURRENT_PAGE -= 1; renderPage(); } };
        if (next) next.onclick = () => { if (CURRENT_PAGE < pages) { CURRENT_PAGE += 1; renderPage(); } };
        container.querySelectorAll('button[data-page]')?.forEach(btn => {
          btn.addEventListener('click', () => {
            const p = Number(btn.getAttribute('data-page') || '1');
            if (!Number.isNaN(p)) { CURRENT_PAGE = p; renderPage(); }
          });
        });
      }

      async function loadStats() {
        const res = await fetch(`${API_BASE}/stats`);
        const data = await res.json();
        renderCloud(catCloud, data.categories || [], 'category');
        renderCloud(tagCloud, data.tags || [], 'tag');
        // 同步 datalist 与缓存
        try {
          const [catsRes, tagsRes] = await Promise.all([
            fetch(`${API_BASE}/categories`),
            fetch(`${API_BASE}/tags`)
          ]);
          cachedCategories = catsRes.ok ? await catsRes.json() : [];
          cachedTags = tagsRes.ok ? await tagsRes.json() : [];
          const catOptions = document.getElementById('categoryOptions');
          const tagOptions = document.getElementById('tagOptions');
          if (catOptions) catOptions.innerHTML = (cachedCategories || []).map(v => `<option value="${String(v).replace(/"/g,'&quot;')}"></option>`).join('');
          if (tagOptions) tagOptions.innerHTML = (cachedTags || []).map(v => `<option value="${String(v).replace(/"/g,'&quot;')}"></option>`).join('');
        } catch (_) {}
      }

      function renderCloud(container, items, type) {
        if (!container) return;
        if (!Array.isArray(items) || items.length === 0) {
          container.innerHTML = '<div class="text-gray-400 text-sm">暂无数据</div>';
          return;
        }
        const max = Math.max(...items.map(i => i.count));
        const min = Math.min(...items.map(i => i.count));
        const range = Math.max(1, max - min);
        container.innerHTML = items.map(i => {
          const weight = (i.count - min) / range; // 0..1
          const font = 12 + Math.round(weight * 14); // 12..26px
          const color = weight > 0.66 ? 'text-blue-700' : (weight > 0.33 ? 'text-blue-600' : 'text-blue-500');
          return `<button data-type="${type}" data-name="${i.name}" class="px-2 py-1 rounded bg-blue-50 ${color}" style="font-size:${font}px">${i.name} (${i.count})</button>`;
        }).join('');

        container.onclick = async (e) => {
          const btn = e.target.closest('button[data-type]');
          if (!btn) return;
          const name = btn.getAttribute('data-name');
          const t = btn.getAttribute('data-type');
          filterType.textContent = t === 'category' ? '分类' : '标签';
          filterValue.textContent = name;
          activeFilter.classList.remove('hidden');
          // 清空搜索框，进入过滤模式
          searchInput.value = '';
          if (t === 'category') {
            const res = await fetch(`${API_BASE}/notes/by_category?category=${encodeURIComponent(name)}`);
            const list = await res.json();
            setNotes(list || []);
          } else {
            const res = await fetch(`${API_BASE}/notes/by_tag?tag=${encodeURIComponent(name)}`);
            const list = await res.json();
            setNotes(list || []);
          }
        };
      }

      clearFilterBtn.addEventListener('click', async () => {
        activeFilter.classList.add('hidden');
        filterType.textContent = '';
        filterValue.textContent = '';
        await loadNotes();
      });

      function renderNotes(notes) {
        const list = document.getElementById("noteList");
        if (notes.length === 0) {
          list.innerHTML = '<div class="text-gray-500 text-center py-10">暂无笔记</div>';
          return;
        }
        list.innerHTML = notes.map(note => `
          <div class="note-card border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer" data-note-id="${note.id ?? ''}" data-note-title="${(note.title || '').replace(/"/g, '&quot;')}" data-note-content="${encodeURIComponent(note.content || '')}">
            <h3 class="text-lg font-semibold text-gray-800">${note.title}</h3>
            <p class="text-sm text-gray-600 mb-2">分类： <span class="category">${note.category}</span></p>
            <div class="flex flex-wrap gap-1 mb-2">
              ${(
                Array.isArray(note.tags)
                  ? note.tags
                  : (note.tags ? String(note.tags).split(',') : [])
              ).map(t => String(t).trim()).filter(t => t).map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
            <p class="text-xs text-gray-500">创建于 ${new Date(note.created_at).toLocaleString()}</p>
          </div>
        `).join('');

        // 点击打开预览（事件委托）
        list.onclick = async (e) => {
          const card = e.target.closest('.note-card');
          if (!card) return;
          const noteId = card.getAttribute('data-note-id');
          const noteTitle = card.getAttribute('data-note-title') || '笔记预览';
          const encodedContent = card.getAttribute('data-note-content') || '';
          let contentText = '';

          if (encodedContent) {
            try { contentText = decodeURIComponent(encodedContent); } catch (_) { contentText = ''; }
          }

          let detail = null;
          if (!contentText && noteId) {
            try {
              const res = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`);
              if (res.ok) {
                detail = await res.json();
                contentText = detail.content || detail.text || '';
              }
            } catch (_) {
              // 忽略网络错误，在下方给出提示
            }
          }

          viewTitle.textContent = noteTitle;
          setViewRaw(contentText || '未能加载到该笔记的正文内容。');
          enterPreviewMode(false);
          // 记录到 modal 元素上，供后续保存使用
          viewNoteModal.setAttribute('data-note-id', noteId || '');
          viewNoteModal.setAttribute('data-note-title', noteTitle || '');
          // 拉详情填充标题/分类/标签
          try {
            const res2 = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`);
            if (res2.ok) {
              const detail2 = await res2.json();
              const et = document.getElementById('editTitle');
              const ec = document.getElementById('editCategory');
              const eg = document.getElementById('editTags');
              if (et) et.value = detail2?.title || noteTitle || '';
              if (ec) ec.value = detail2?.category || '';
              if (eg) eg.value = detail2?.tags || '';
            }
          } catch (_) {}
          viewNoteModal.classList.remove('hidden');
        };
      }
      // AI 优化
      if (optimizeBtn) {
        optimizeBtn.onclick = async () => {
          const content = currentViewRaw || '';
          if (!content.trim()) {
            alert('没有可优化的内容');
            return;
          }
          const prompt = (optPrompt && optPrompt.value.trim()) || '帮助用户完善笔记文档，并整理归类总结';
          try {
            optStatus.classList.remove('hidden');
            optimizeBtn.disabled = true;
            saveOptimizedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/optimize`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content, prompt })
            });
            if (!res.ok) {
              let msg = '';
              try {
                const err = await res.json();
                msg = err?.detail || err?.error || '';
              } catch (_) {
                try { msg = await res.text(); } catch (_) { msg = ''; }
              }
              alert('优化失败' + (msg ? `：${msg}` : `（HTTP ${res.status}）`));
              return;
            }
            const data = await res.json();
            const optimized = (data && data.optimized) || '';
            const category = (data && data.category) || '';
            const tags = (data && data.tags);
            if (optimized) {
              setViewRaw(optimized);
              saveOptimizedBtn.disabled = false;
              enterPreviewMode(false);
            }
            // 回填分类/标签（编辑区）
            const ec = document.getElementById('editCategory');
            const eg = document.getElementById('editTags');
            if (ec && category) ec.value = category;
            if (eg && (Array.isArray(tags) ? tags.length : (typeof tags === 'string' && tags.trim().length))) {
              eg.value = Array.isArray(tags) ? tags.join(', ') : String(tags);
            }
            // 提示
            try {
              if (optStatus) {
                const tagStr = Array.isArray(tags) ? tags.join(', ') : (typeof tags === 'string' ? tags : '');
                optStatus.textContent = `已提取分类：${category || '（无）'}；标签：${tagStr || '（无）'}`;
                optStatus.classList.remove('hidden');
                setTimeout(()=>{ optStatus.classList.add('hidden'); }, 2500);
              }
            } catch (_) {}
          } catch (e) {
            alert('网络异常，优化失败');
          } finally {
            optStatus.classList.add('hidden');
            optimizeBtn.disabled = false;
          }
        };
      }

      // 保存优化后的更新
      if (saveOptimizedBtn) {
        // 任意编辑变更即允许保存
        ['input','change','keyup'].forEach(evt => {
          if (viewEditor) viewEditor.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          const et = document.getElementById('editTitle');
          const ec = document.getElementById('editCategory');
          const eg = document.getElementById('editTags');
          if (et) et.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          if (ec) ec.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
          if (eg) eg.addEventListener(evt, () => { saveOptimizedBtn.disabled = false; });
        });

        saveOptimizedBtn.onclick = async () => {
          const noteId = viewNoteModal.getAttribute('data-note-id');
          if (!noteId) {
            alert('未获取到笔记 ID，无法保存');
            return;
          }
          const title = (document.getElementById('editTitle')?.value || viewNoteModal.getAttribute('data-note-title') || '').trim();
          const category = (document.getElementById('editCategory')?.value || '').trim();
          const tags = (document.getElementById('editTags')?.value || '').trim();
          // 若在编辑模式，优先从编辑器取值，并同步到预览原文
          let content = currentViewRaw || '';
          if (viewEditor && !viewEditor.classList.contains('hidden')) {
            content = viewEditor.value || '';
            currentViewRaw = content;
          }
          try {
            saveOptimizedBtn.disabled = true;
            const res = await fetch(`${API_BASE}/note`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: Number(noteId), title, content, category, tags })
            });
            if (res.ok) {
              alert('已保存优化/编辑结果');
              await Promise.all([loadNotes(), loadStats()]);
              viewNoteModal.classList.add('hidden');
            } else {
              const err = await res.json().catch(() => ({}));
              alert('保存失败' + (err && err.detail ? `：${err.detail}` : ''));
            }
          } catch (_) {
            alert('网络异常，保存失败');
          } finally {
            saveOptimizedBtn.disabled = false;
          }
        };
      }

      // 删除笔记
      if (deleteNoteBtn) {
        deleteNoteBtn.onclick = async () => {
          const noteId = viewNoteModal.getAttribute('data-note-id');
          if (!noteId) {
            alert('未获取到笔记 ID，无法删除');
            return;
          }
          if (!confirm('确定要删除这条笔记吗？此操作不可恢复。')) return;
          try {
            const res = await fetch(`${API_BASE}/note?id=${encodeURIComponent(noteId)}`, { method: 'DELETE' });
            if (res.ok) {
              alert('已删除');
              await Promise.all([loadNotes(), loadStats()]);
              viewNoteModal.classList.add('hidden');
            } else {
              let msg = '';
              try { const err = await res.json(); msg = err?.detail || err?.error || ''; } catch(_) {}
              alert('删除失败' + (msg ? `：${msg}` : `（HTTP ${res.status}）`));
            }
          } catch (_) {
            alert('网络异常，删除失败');
          }
        };
      }

      // 初始加载
      await loadNotes();

      // 绑定模糊建议到输入框
      attachFuzzySuggest(document.getElementById('noteCategory'), () => cachedCategories, false);
      attachFuzzySuggest(document.getElementById('editCategory'), () => cachedCategories, false);
      attachFuzzySuggest(document.getElementById('noteTags'), () => cachedTags, true);
      attachFuzzySuggest(document.getElementById('editTags'), () => cachedTags, true);
    });
  </script>
</body>
</html>